<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>leverTsui</title>
  
  <subtitle>要有狮子的力量， 菩萨的心肠</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://leverTsui.github.io/"/>
  <updated>2018-06-27T02:50:21.733Z</updated>
  <id>http://leverTsui.github.io/</id>
  
  <author>
    <name>leverTsui</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>iOS长按移动Table View Cells</title>
    <link href="http://leverTsui.github.io/2018/01/19/iOS%E9%95%BF%E6%8C%89%E7%A7%BB%E5%8A%A8Table%20View%20Cells/"/>
    <id>http://leverTsui.github.io/2018/01/19/iOS长按移动Table View Cells/</id>
    <published>2018-01-19T05:01:28.000Z</published>
    <updated>2018-06-27T02:50:21.733Z</updated>
    
    <content type="html"><![CDATA[<h4 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h4><p>最近参与了事务流程工具化组件的开发，其中有一个模块需要通过长按移动<code>Table View Cells</code>，来达到调整任务的需求，再次记录下开发过程中的实现思路。完成后的效果如下图所示：</p><p><img src="http://upload-images.jianshu.io/upload_images/117999-aca3146c0222d73a.gif?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="长按移动cell.gif"></p><h4 id="实现思路"><a href="#实现思路" class="headerlink" title="实现思路"></a>实现思路</h4><h5 id="添加手势"><a href="#添加手势" class="headerlink" title="添加手势"></a>添加手势</h5><p>首先给 <code>collection view</code> 添加一个 <code>UILongGestureRecognizer</code>,在项目中一般使用懒加载的方式来对对象进行初始化：</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">- (<span class="built_in">UICollectionView</span> *)collectionView &#123;</div><div class="line">    <span class="keyword">if</span> (!_collectionView) &#123;</div><div class="line">        _collectionView =  [[<span class="built_in">UICollectionView</span> alloc] initWithFrame:<span class="built_in">CGRectZero</span> collectionViewLayout:<span class="keyword">self</span>.flowLayout];</div><div class="line">        </div><div class="line">        _collectionView.backgroundColor = [<span class="built_in">UIColor</span> whiteColor];</div><div class="line">        _collectionView.dataSource = <span class="keyword">self</span>;</div><div class="line">        _collectionView.delegate = <span class="keyword">self</span>;</div><div class="line">        </div><div class="line">        [_collectionView registerClass:[TLCMainCollectionViewCell <span class="keyword">class</span>] forCellWithReuseIdentifier:[TLCMainCollectionViewCell identifier]];</div><div class="line">        </div><div class="line">        _collectionView.showsHorizontalScrollIndicator = <span class="literal">NO</span>;</div><div class="line">        _collectionView.showsVerticalScrollIndicator = <span class="literal">NO</span>;</div><div class="line">        _collectionView.bounces = <span class="literal">YES</span>;</div><div class="line">        _collectionView.decelerationRate = <span class="number">0</span>;</div><div class="line">        </div><div class="line">        [_collectionView addGestureRecognizer:<span class="keyword">self</span>.longPress];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> _collectionView;</div><div class="line">&#125;</div></pre></td></tr></table></figure><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">- (<span class="built_in">UILongPressGestureRecognizer</span> *)longPress &#123;</div><div class="line">    <span class="keyword">if</span> (!_longPress) &#123;</div><div class="line">        _longPress = [[<span class="built_in">UILongPressGestureRecognizer</span> alloc] initWithTarget:<span class="keyword">self</span> action:<span class="keyword">@selector</span>(longPressGestureRecognized:)];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> _longPress;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>在用户长按后，触犯长按事件，先获取到当前手势所在的<code>collection view</code>位置，再做后续的处理。<br></p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)longPressGestureRecognized:(<span class="built_in">UILongPressGestureRecognizer</span> *)sender &#123;</div><div class="line">    </div><div class="line">    <span class="built_in">CGPoint</span> location = [sender locationInView:sender.view];</div><div class="line">    </div><div class="line">    <span class="built_in">UIGestureRecognizerState</span> state = sender.state;</div><div class="line">    <span class="keyword">switch</span> (state) &#123;</div><div class="line">            <span class="keyword">case</span> <span class="built_in">UIGestureRecognizerStateBegan</span>: &#123;</div><div class="line">                [<span class="keyword">self</span> handleLongPressStateBeganWithLocation:location];</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">            </div><div class="line">            <span class="keyword">case</span> <span class="built_in">UIGestureRecognizerStateChanged</span>: &#123;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">            </div><div class="line">            <span class="keyword">case</span> <span class="built_in">UIGestureRecognizerStateEnded</span>:</div><div class="line">            <span class="keyword">case</span> <span class="built_in">UIGestureRecognizerStateCancelled</span>: &#123;</div><div class="line">                [<span class="keyword">self</span> longGestureEndedOrCancelledWithLocation:location];</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">            </div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><h5 id="长按手势状态为开始"><a href="#长按手势状态为开始" class="headerlink" title="长按手势状态为开始"></a>长按手势状态为开始</h5><p>主要处理两个方面的事务，一为获取当前长按手势所对应的<code>Table View Cell</code>的镜像，将其添加到 <code>Collection View</code>上。二为一些初始状态的设置，后续在移动后网络请求出错及判断当前手势所处的<code>Table View</code>和上一次是否一致需要使用到。最后调用<code>startPageEdgeScroll</code>开启定时器。<br></p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)handleLongPressStateBeganWithLocation:(<span class="built_in">CGPoint</span>)location &#123;</div><div class="line">    </div><div class="line">    TLCMainCollectionViewCell *selectedCollectionViewCell = [<span class="keyword">self</span> currentTouchedCollectionCellWithLocation:location];</div><div class="line">    </div><div class="line">    <span class="built_in">NSIndexPath</span> *touchIndexPath = [<span class="keyword">self</span> longGestureBeganIndexPathForRowAtPoint:location atTableView:selectedCollectionViewCell.tableView];</div><div class="line">   </div><div class="line">    <span class="keyword">if</span> (!selectedCollectionViewCell || !touchIndexPath) &#123;</div><div class="line">        <span class="keyword">return</span> ;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">self</span>.selectedCollectionViewCellRow = [<span class="keyword">self</span>.collectionView indexPathForCell:selectedCollectionViewCell].row;</div><div class="line">    </div><div class="line">    <span class="comment">// 已完成的任务，不支持排序</span></div><div class="line">    TLPlanItem *selectedItem = [<span class="keyword">self</span>.viewModel itemAtIndex:<span class="keyword">self</span>.selectedCollectionViewCellRow</div><div class="line">                                              subItemIndex:touchIndexPath.section];</div><div class="line">    <span class="keyword">if</span> (!selectedItem || selectedItem.finish) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    selectedItem.isHidden = <span class="literal">YES</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">self</span>.snapshotView = [<span class="keyword">self</span> snapshotViewWithTableView:selectedCollectionViewCell.tableView</div><div class="line">                                            atIndexPath:touchIndexPath];</div><div class="line">    [<span class="keyword">self</span>.collectionView addSubview:<span class="keyword">self</span>.snapshotView];</div><div class="line">    </div><div class="line">    <span class="keyword">self</span>.selectedIndexPath = touchIndexPath;</div><div class="line">    <span class="keyword">self</span>.originalSelectedIndexPathSection = touchIndexPath.section;</div><div class="line">    <span class="keyword">self</span>.originalCollectionViewCellRow = <span class="keyword">self</span>.selectedCollectionViewCellRow;</div><div class="line">    <span class="keyword">self</span>.previousPoint = <span class="built_in">CGPointZero</span>;</div><div class="line">    </div><div class="line">    [<span class="keyword">self</span> startPageEdgeScroll];</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><h5 id="长按手势状态为改变"><a href="#长按手势状态为改变" class="headerlink" title="长按手势状态为改变"></a>长按手势状态为改变</h5><p>在<code>longPressGestureRecognized</code>方法中，可以发现，长按手势状态改变时，并未做任何的操作，主要原因是如果在此做<code>Table View Cells</code>的移动操作，如果数据超过一屏幕，无法自动将未在屏幕上的数据滚动显示出来。所以在长按手势状态为开始时，如果触摸点在<code>Table View Cell</code>上，开启定时器，来处理长按手势状态为改变时的情况。<br></p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)startPageEdgeScroll &#123;</div><div class="line">    <span class="keyword">self</span>.edgeScrollTimer = [<span class="built_in">CADisplayLink</span> displayLinkWithTarget:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(pageEdgeScrollEvent)];</div><div class="line">    [<span class="keyword">self</span>.edgeScrollTimer addToRunLoop:[<span class="built_in">NSRunLoop</span> mainRunLoop] forMode:<span class="built_in">NSRunLoopCommonModes</span>];</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><p>在定时器触发的事件中，处理两个方面的事情，移动cell和滚动<code>ScrollView</code>。<br></p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)pageEdgeScrollEvent &#123;</div><div class="line">    [<span class="keyword">self</span> longGestureChanged:<span class="keyword">self</span>.longPress];</div><div class="line">    </div><div class="line">    <span class="built_in">CGFloat</span> snapshotViewCenterOffsetX =  [<span class="keyword">self</span> touchSnapshotViewCenterOffsetX];</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (fabs(snapshotViewCenterOffsetX) &gt; (TLCMainViewControllerFlowLayoutWidthOffset<span class="number">-20</span>)) &#123;</div><div class="line">        <span class="comment">//横向滚动</span></div><div class="line">        [<span class="keyword">self</span> handleScrollViewHorizontalScroll:<span class="keyword">self</span>.collectionView viewCenterOffsetX:snapshotViewCenterOffsetX];</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">//垂直滚动</span></div><div class="line">        [<span class="keyword">self</span> handleScrollViewVerticalScroll:[<span class="keyword">self</span> selectedCollectionViewCellTableView]];</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><p>在长按手势触摸点位置改变时，处理对应<code>cell</code>的移除和插入动作。横向滚动和垂直滚动主要是根据不同情况设置对应的<code>Table View</code> 和 <code>Collection View</code>的内容偏移量。可以在文末的链接中查看源码。<br></p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)longGestureChanged:(<span class="built_in">UILongPressGestureRecognizer</span> *)sender &#123;</div><div class="line">    </div><div class="line">    <span class="built_in">CGPoint</span> currentPoint = [sender locationInView:sender.view];</div><div class="line">    TLCMainCollectionViewCell *currentCollectionViewCell = [<span class="keyword">self</span> currentTouchedCollectionCellWithLocation:currentPoint];</div><div class="line">    <span class="keyword">if</span> (!currentCollectionViewCell) &#123;</div><div class="line">        currentCollectionViewCell = [<span class="keyword">self</span> collectionViewCellAtRow:<span class="keyword">self</span>.selectedCollectionViewCellRow];</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    TLCMainCollectionViewCell *lasetSelectedCollectionViewCell = [<span class="keyword">self</span> collectionViewCellAtRow:<span class="keyword">self</span>.selectedCollectionViewCellRow];</div><div class="line">    </div><div class="line">    <span class="comment">//判断targetTableView是否改变</span></div><div class="line">    <span class="built_in">BOOL</span> isTargetTableViewChanged = <span class="literal">NO</span>;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.selectedCollectionViewCellRow != currentCollectionViewCell.indexPath.row) &#123;</div><div class="line">        isTargetTableViewChanged = <span class="literal">YES</span>;</div><div class="line">        <span class="keyword">self</span>.selectedCollectionViewCellRow = currentCollectionViewCell.indexPath.row;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//获取到需要移动到的目标indexpath</span></div><div class="line">    <span class="built_in">NSIndexPath</span> *targetIndexPath = [<span class="keyword">self</span> longGestureChangeIndexPathForRowAtPoint:currentPoint</div><div class="line">                                                        collectionViewCell:currentCollectionViewCell];</div><div class="line">    </div><div class="line">    <span class="built_in">NSIndexPath</span> *lastSelectedIndexPath = <span class="keyword">self</span>.selectedIndexPath;</div><div class="line">    </div><div class="line">    TLCMainCollectionViewCell *selectedCollectionViewCell = [<span class="keyword">self</span> collectionViewCellAtRow:<span class="keyword">self</span>.selectedCollectionViewCellRow];</div><div class="line">    <span class="comment">//判断跟上一次长按手势所处的Table View是否相同，如果相同，移动cell，</span></div><div class="line">    <span class="comment">//如果不同，删除上一次所定义的cell，插入到当前位置</span></div><div class="line">    <span class="keyword">if</span> (isTargetTableViewChanged) &#123;</div><div class="line">        <span class="keyword">if</span> ([[<span class="keyword">self</span> selectedCollectionViewCellTableView] numberOfSections]&gt;targetIndexPath.section) &#123;</div><div class="line">            [[<span class="keyword">self</span> selectedCollectionViewCellTableView] scrollToRowAtIndexPath:targetIndexPath</div><div class="line">                                                              atScrollPosition:<span class="built_in">UITableViewScrollPositionNone</span> animated:<span class="literal">YES</span>];</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        TLPlanItem *moveItem = [<span class="keyword">self</span>.viewModel itemAtIndex:lasetSelectedCollectionViewCell.indexPath.row</div><div class="line">                                              subItemIndex:lastSelectedIndexPath.section];</div><div class="line">        [<span class="keyword">self</span>.viewModel removeObject:moveItem</div><div class="line">                           itemIndex:lasetSelectedCollectionViewCell.indexPath.row];</div><div class="line">        [<span class="keyword">self</span>.viewModel insertItem:moveItem</div><div class="line">                             index:<span class="keyword">self</span>.selectedCollectionViewCellRow</div><div class="line">                      subItemIndex:targetIndexPath.section];</div><div class="line"></div><div class="line">        [lasetSelectedCollectionViewCell updateCellWithData:[<span class="keyword">self</span> planItemsAtIndex:lasetSelectedCollectionViewCell.indexPath.row]];</div><div class="line">        [lasetSelectedCollectionViewCell.tableView deleteSections:[<span class="built_in">NSIndexSet</span> indexSetWithIndex:lastSelectedIndexPath.section]</div><div class="line">                                                 withRowAnimation:<span class="built_in">UITableViewRowAnimationNone</span>];</div><div class="line"></div><div class="line">        [selectedCollectionViewCell updateCellWithData:[<span class="keyword">self</span> planItemsAtIndex:<span class="keyword">self</span>.selectedCollectionViewCellRow]];</div><div class="line">        [selectedCollectionViewCell.tableView insertSections:[<span class="built_in">NSIndexSet</span> indexSetWithIndex:targetIndexPath.section]</div><div class="line">                                            withRowAnimation:<span class="built_in">UITableViewRowAnimationNone</span>];</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="built_in">BOOL</span> isSameSection = lastSelectedIndexPath.section == targetIndexPath.section;</div><div class="line">        <span class="built_in">UITableViewCell</span> *targetCell = [<span class="keyword">self</span> tableView:[<span class="keyword">self</span> selectedCollectionViewCellTableView]</div><div class="line">                                selectedCellAtSection:targetIndexPath.section];</div><div class="line">        <span class="keyword">if</span> (isSameSection || !targetCell ) &#123;</div><div class="line">            [<span class="keyword">self</span> modifySnapshotViewFrameWithTouchPoint:currentPoint];</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        TLPlanItem *item = [<span class="keyword">self</span>.viewModel itemAtIndex:<span class="keyword">self</span>.selectedCollectionViewCellRow</div><div class="line">                                          subItemIndex:lastSelectedIndexPath.section];</div><div class="line">        [<span class="keyword">self</span>.viewModel removeObject:item</div><div class="line">                           itemIndex:<span class="keyword">self</span>.selectedCollectionViewCellRow];</div><div class="line">        [<span class="keyword">self</span>.viewModel insertItem:item</div><div class="line">                             index:<span class="keyword">self</span>.selectedCollectionViewCellRow</div><div class="line">                      subItemIndex:targetIndexPath.section];</div><div class="line">        </div><div class="line">        [selectedCollectionViewCell updateCellWithData:[<span class="keyword">self</span> planItemsAtIndex:<span class="keyword">self</span>.selectedCollectionViewCellRow]];</div><div class="line">        [selectedCollectionViewCell.tableView moveSection:lastSelectedIndexPath.section</div><div class="line">                                                toSection:targetIndexPath.section];</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">self</span>.selectedIndexPath = targetIndexPath;</div><div class="line">    <span class="comment">//改变长按cell镜像的位置</span></div><div class="line">    [<span class="keyword">self</span> modifySnapshotViewFrameWithTouchPoint:currentPoint];</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><h5 id="长按手势状态为取消或结束"><a href="#长按手势状态为取消或结束" class="headerlink" title="长按手势状态为取消或结束"></a>长按手势状态为取消或结束</h5><p>取消计时器，设置<code>Collection View</code>的偏移量，让其<code>Collection View Cell</code>位于屏幕的中心，发送网络请求，去调整任务的排序，同时将镜像视图隐藏，并将其所对应的<code>Table View Cell</code>显示出来。</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)longGestureEndedOrCancelledWithLocation:(<span class="built_in">CGPoint</span>)location &#123;</div><div class="line">    </div><div class="line">    [<span class="keyword">self</span> stopEdgeScrollTimer];</div><div class="line">    </div><div class="line">    <span class="built_in">CGPoint</span> contentOffset = [<span class="keyword">self</span>.flowLayout targetContentOffsetForProposedContentOffset:<span class="keyword">self</span>.collectionView.contentOffset</div><div class="line">                                                                   withScrollingVelocity:<span class="built_in">CGPointZero</span>];</div><div class="line">    [<span class="keyword">self</span>.collectionView setContentOffset:contentOffset animated:<span class="literal">YES</span>];</div><div class="line">    </div><div class="line">    <span class="built_in">UITableViewCell</span> *targetCell = [[<span class="keyword">self</span> selectedCollectionViewCellTableView] cellForRowAtIndexPath:<span class="keyword">self</span>.selectedIndexPath];</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> ([<span class="keyword">self</span> canAdjustPlanRanking]) &#123;</div><div class="line">        [<span class="keyword">self</span> adjustPlanRanking];</div><div class="line">    &#125;</div><div class="line">    TLPlanItem *slectedItem = [<span class="keyword">self</span>.viewModel itemAtIndex:<span class="keyword">self</span>.selectedCollectionViewCellRow subItemIndex:<span class="keyword">self</span>.selectedIndexPath.section];</div><div class="line">    [<span class="built_in">UIView</span> animateWithDuration:<span class="number">0.25</span> animations:^&#123;</div><div class="line">        <span class="keyword">self</span>.snapshotView.transform = <span class="built_in">CGAffineTransformIdentity</span>;</div><div class="line">        <span class="keyword">self</span>.snapshotView.frame = [<span class="keyword">self</span> snapshotViewFrameWithCell:targetCell];</div><div class="line">        </div><div class="line">    &#125; completion:^(<span class="built_in">BOOL</span> finished) &#123;</div><div class="line">        targetCell.hidden = <span class="literal">NO</span>;</div><div class="line">        slectedItem.isHidden = <span class="literal">NO</span>;</div><div class="line">        [<span class="keyword">self</span>.snapshotView removeFromSuperview];</div><div class="line">        <span class="keyword">self</span>.snapshotView = <span class="literal">nil</span>;</div><div class="line">    &#125;];</div><div class="line">&#125;</div></pre></td></tr></table></figure><h5 id="数据的处理"><a href="#数据的处理" class="headerlink" title="数据的处理"></a>数据的处理</h5><p>在移动和插入<code>Table View Cell</code>时，需要将其所对应的数据做响应的改变，数据相关的操作均放在<code>TLCMainViewModel</code>对象中。</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">TLCMainViewModel</span> : <span class="title">NSObject</span> </span></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> 今日要做、下一步要做和以后要做</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>, <span class="keyword">strong</span>) <span class="built_in">NSArray</span> &lt;<span class="built_in">NSString</span> *&gt; *titleArray; </div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> 获取计划列表</span></div><div class="line"><span class="comment"> </span></div><div class="line"><span class="comment"> @param completion  TLTodoModel</span></div><div class="line"><span class="comment"> */</span></div><div class="line">- (<span class="keyword">void</span>)obtainTotalPlanListWithTypeCompletion:(TLSDKCompletionBlk)completion;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> 添加计划</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment"> @param requestItem requestItem</span></div><div class="line"><span class="comment"> @param completion 完成回调</span></div><div class="line"><span class="comment"> */</span></div><div class="line">- (<span class="keyword">void</span>)addPlanWithReq:(TLPlanItemReq *)requestItem</div><div class="line">           atIndexPath:(<span class="built_in">NSIndexPath</span> *)indexPath</div><div class="line">            completion:(TLSDKCompletionBlk)completion;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> 返回显示的collectionViewCell的个数</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment"> @return 数据的个数</span></div><div class="line"><span class="comment"> */</span></div><div class="line">- (<span class="built_in">NSInteger</span>)numberOfItems;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> 根据type获取对应的数据</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment"> @param index 位置</span></div><div class="line"><span class="comment"> @return 此计划所对应的数据</span></div><div class="line"><span class="comment"> */</span></div><div class="line">- (<span class="built_in">NSMutableArray</span>&lt;TLPlanItem *&gt; *)planItemsAtIndex:(<span class="built_in">NSInteger</span>)index;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> 删除某个计划</span></div><div class="line"><span class="comment"> </span></div><div class="line"><span class="comment"> @param itemIndex 单项数据在数组中的位置，如今日计划中的数据，itemIndex为0</span></div><div class="line"><span class="comment"> @param subItemIndex  单项数据数组中所在的位置</span></div><div class="line"><span class="comment"> @param completion 完成回调</span></div><div class="line"><span class="comment"> */</span></div><div class="line">- (<span class="keyword">void</span>)deletePlanAtItemIndex:(<span class="built_in">NSInteger</span>)itemIndex</div><div class="line">                 subItemIndex:(<span class="built_in">NSInteger</span>)subItemIndex</div><div class="line">                   completion:(dispatch_block_t)completion;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> 修改计划状态：完成与非完成</span></div><div class="line"><span class="comment"> </span></div><div class="line"><span class="comment"> @param itemIndex 单项数据在数组中的位置，如今日计划中的数据，itemIndex为0</span></div><div class="line"><span class="comment"> @param subItemIndex  单项数据数组中所在的位置</span></div><div class="line"><span class="comment"> @param completion 完成回调</span></div><div class="line"><span class="comment"> */</span></div><div class="line">- (<span class="keyword">void</span>)modiflyPlanStateAtItemIndex:(<span class="built_in">NSInteger</span>)itemIndex</div><div class="line">                       subItemIndex:(<span class="built_in">NSInteger</span>)subItemIndex</div><div class="line">                         completion:(TLSDKCompletionBlk)completion;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> 修改计划的title和重点标记状态</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment"> @param itemIndex 单项数据在数组中的位置，如今日计划中的数据，itemIndex为0</span></div><div class="line"><span class="comment"> @param subItemIndex 单项数据数组中所在的位置</span></div><div class="line"><span class="comment"> @param targetItem 目标对象</span></div><div class="line"><span class="comment"> @param completion 完成回调</span></div><div class="line"><span class="comment"> */</span></div><div class="line">- (<span class="keyword">void</span>)modiflyItemAtIndex:(<span class="built_in">NSInteger</span>)itemIndex</div><div class="line">              subItemIndex:(<span class="built_in">NSInteger</span>)subItemIndex</div><div class="line">                targetItem:(TLPlanItem *)targetItem</div><div class="line">                completion:(dispatch_block_t)completion;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> 移除数据</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment"> @param item item</span></div><div class="line"><span class="comment"> @param itemIndex 单项数据在数组中的位置</span></div><div class="line"><span class="comment"> */</span></div><div class="line">- (<span class="keyword">void</span>)removeObject:(TLPlanItem *)item</div><div class="line">           itemIndex:(<span class="built_in">NSInteger</span>)itemIndex;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> 插入数据</span></div><div class="line"><span class="comment"> </span></div><div class="line"><span class="comment"> @param item 插入的对象模型</span></div><div class="line"><span class="comment"> @param itemIndex 单项数据在数组中的位置，如今日计划中的数据，itemIndex为0</span></div><div class="line"><span class="comment"> @param subItemIndex 单项数据数组中所在的位置</span></div><div class="line"><span class="comment"> */</span></div><div class="line">- (<span class="keyword">void</span>)insertItem:(TLPlanItem *)item</div><div class="line">             index:(<span class="built_in">NSInteger</span>)itemIndex</div><div class="line">      subItemIndex:(<span class="built_in">NSInteger</span>)subItemIndex;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> 获取数据</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment"> @param itemIndex 一级index</span></div><div class="line"><span class="comment"> @param subItemIndex 二级index</span></div><div class="line"><span class="comment"> @return 数据模型</span></div><div class="line"><span class="comment"> */</span></div><div class="line">- (TLPlanItem *)itemAtIndex:(<span class="built_in">NSInteger</span>)itemIndex</div><div class="line">               subItemIndex:(<span class="built_in">NSInteger</span>)subItemIndex; </div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> 重置数据</span></div><div class="line"><span class="comment"> */</span></div><div class="line">- (<span class="keyword">void</span>)reset;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> 保存长按开始时的数据</span></div><div class="line"><span class="comment"> */</span></div><div class="line">- (<span class="keyword">void</span>)storePressBeginState;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure><h4 id="代码完善"><a href="#代码完善" class="headerlink" title="代码完善"></a>代码完善</h4><h5 id="cell未居中显示问题"><a href="#cell未居中显示问题" class="headerlink" title="cell未居中显示问题"></a><code>cell</code>未居中显示问题</h5><p><code>2018年2月1号</code><br>在iPhone系统版本为<code>iOS8.x</code>和<code>iOS9.x</code>时，会出现<code>以后要做</code>界面不会回弹的情况。如下图所示：<br><img src="http://upload-images.jianshu.io/upload_images/117999-dfea45068404f800.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="bug1.png"></p><p>经排查，是在<code>UICollectionViewFlowLayout</code>类中的<br></p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">- (<span class="built_in">CGPoint</span>)targetContentOffsetForProposedContentOffset:(<span class="built_in">CGPoint</span>)proposedContentOffset withScrollingVelocity:(<span class="built_in">CGPoint</span>)velocity</div></pre></td></tr></table></figure><p></p><p>方法计算得出的<code>proposedContentOffset</code>有偏差，修改后如下所示：</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">- (<span class="built_in">CGPoint</span>)targetContentOffsetForProposedContentOffset:(<span class="built_in">CGPoint</span>)proposedContentOffset withScrollingVelocity:(<span class="built_in">CGPoint</span>)velocity &#123;</div><div class="line">    <span class="built_in">CGFloat</span> rawPageValue = <span class="keyword">self</span>.collectionView.contentOffset.x / [<span class="keyword">self</span> tlc_pageWidth];</div><div class="line">    <span class="built_in">CGFloat</span> currentPage = (velocity.x &gt; <span class="number">0.0</span>) ? floor(rawPageValue) : ceil(rawPageValue);</div><div class="line">    <span class="built_in">CGFloat</span> nextPage = (velocity.x &gt; <span class="number">0.0</span>) ? ceil(rawPageValue) : floor(rawPageValue);</div><div class="line">    </div><div class="line">    <span class="built_in">BOOL</span> pannedLessThanAPage = fabs(<span class="number">1</span> + currentPage - rawPageValue) &gt; <span class="number">0.5</span>;</div><div class="line">    <span class="built_in">BOOL</span> flicked = fabs(velocity.x) &gt; [<span class="keyword">self</span> tlc_flickVelocity];</div><div class="line">    <span class="built_in">CGFloat</span> actualPage = <span class="number">0.0</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (pannedLessThanAPage &amp;&amp; flicked) &#123;</div><div class="line">        proposedContentOffset.x = nextPage * [<span class="keyword">self</span> tlc_pageWidth];</div><div class="line">        actualPage = nextPage;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        proposedContentOffset.x = round(rawPageValue) * [<span class="keyword">self</span> tlc_pageWidth];</div><div class="line">        actualPage = round(rawPageValue);</div><div class="line">    &#125; </div><div class="line">    <span class="keyword">if</span> (lround(actualPage) &gt;= <span class="number">1</span>) &#123;</div><div class="line">        proposedContentOffset.x -= <span class="number">4.5</span>;</div><div class="line">    &#125; </div><div class="line">    <span class="comment">//下面为添加的代码</span></div><div class="line">    <span class="keyword">if</span> (lround(actualPage) &gt;= <span class="number">2</span>) &#123;</div><div class="line">        proposedContentOffset.x = <span class="keyword">self</span>.collectionView.contentSize.width - TLCScreenWidth;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> proposedContentOffset;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h5 id="在系统版本为iOS9-x时，输入框会上一段距离问题"><a href="#在系统版本为iOS9-x时，输入框会上一段距离问题" class="headerlink" title="在系统版本为iOS9.x时，输入框会上一段距离问题"></a>在系统版本为iOS9.x时，输入框会上一段距离问题</h5><p><code>2018年2月12号</code><br>在机型为iPhone SE，系统版本为iOS9.x时，新建计划时，新建窗口会上移一段，如下图所示：<br><img src="http://upload-images.jianshu.io/upload_images/117999-edc9204a4f9985ab.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="适配问题.png"><br>分析发现，应该是监听键盘高度变化时，输入框的高度计算在特定机型的特定版本上计算错误，将原有的计算<code>frame</code>的来布局的方式改为自动布局。监听键盘高度改变的代码修改后如下：<br></p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">- (<span class="keyword">void</span>)viewWillAppear:(<span class="built_in">BOOL</span>)animated&#123;</div><div class="line">    </div><div class="line">    [<span class="keyword">super</span> viewWillAppear:animated]; </div><div class="line">    [<span class="keyword">self</span> addObserverForKeybord];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)viewWillDisappear:(<span class="built_in">BOOL</span>)animated &#123;</div><div class="line">    </div><div class="line">    [<span class="keyword">super</span> viewWillDisappear:animated];</div><div class="line">    [<span class="keyword">self</span>.view endEditing:<span class="literal">YES</span>];</div><div class="line">    [<span class="keyword">self</span> removeobserverForKeybord];</div><div class="line">&#125;</div><div class="line"><span class="meta">#pragma mark - keyboard observer</span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)addObserverForKeybord &#123;</div><div class="line">    </div><div class="line">    [[<span class="built_in">NSNotificationCenter</span> defaultCenter] addObserver:<span class="keyword">self</span></div><div class="line">                                             selector:<span class="keyword">@selector</span>(keyboardWillShow:)</div><div class="line">                                                 name:<span class="built_in">UIKeyboardWillShowNotification</span></div><div class="line">                                               object:<span class="literal">nil</span>];</div><div class="line">    </div><div class="line">    [[<span class="built_in">NSNotificationCenter</span> defaultCenter] addObserver:<span class="keyword">self</span></div><div class="line">                                             selector:<span class="keyword">@selector</span>(keyboardWillHide:)</div><div class="line">                                                 name:<span class="built_in">UIKeyboardWillHideNotification</span></div><div class="line">                                               object:<span class="literal">nil</span>];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)removeobserverForKeybord &#123;</div><div class="line">    </div><div class="line">    [[<span class="built_in">NSNotificationCenter</span> defaultCenter] removeObserver:<span class="keyword">self</span></div><div class="line">                                                    name:<span class="built_in">UIKeyboardWillShowNotification</span></div><div class="line">                                                  object:<span class="literal">nil</span>];</div><div class="line">    </div><div class="line">    [[<span class="built_in">NSNotificationCenter</span> defaultCenter] removeObserver:<span class="keyword">self</span></div><div class="line">                                                    name:<span class="built_in">UIKeyboardWillHideNotification</span></div><div class="line">                                                  object:<span class="literal">nil</span>];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)keyboardWillShow:(<span class="built_in">NSNotification</span> *)notification &#123;</div><div class="line">    </div><div class="line">    <span class="built_in">CGRect</span> keyboardBounds;</div><div class="line">    [[notification.userInfo valueForKey:<span class="built_in">UIKeyboardFrameEndUserInfoKey</span>] getValue:&amp;keyboardBounds];</div><div class="line">    <span class="built_in">NSNumber</span> *duration = [notification.userInfo objectForKey:<span class="built_in">UIKeyboardAnimationDurationUserInfoKey</span>];</div><div class="line">    <span class="built_in">NSNumber</span> *curve = [notification.userInfo objectForKey:<span class="built_in">UIKeyboardAnimationCurveUserInfoKey</span>];</div><div class="line">    </div><div class="line">    keyboardBounds = [<span class="keyword">self</span>.view convertRect:keyboardBounds toView:<span class="literal">nil</span>];</div><div class="line">    </div><div class="line">    [<span class="keyword">self</span>.inputProjectView mas_updateConstraints:^(MASConstraintMaker *make) &#123;</div><div class="line">        make.bottom.equalTo(<span class="keyword">self</span>.view).offset(-<span class="built_in">CGRectGetHeight</span>(keyboardBounds));</div><div class="line">    &#125;];</div><div class="line">    </div><div class="line">    <span class="comment">//设置动画</span></div><div class="line">    [<span class="built_in">UIView</span> beginAnimations:<span class="literal">nil</span> context:<span class="literal">NULL</span>];</div><div class="line">    [<span class="built_in">UIView</span> setAnimationBeginsFromCurrentState:<span class="literal">YES</span>];</div><div class="line">    [<span class="built_in">UIView</span> setAnimationDuration:[duration doubleValue]];</div><div class="line">    [<span class="built_in">UIView</span> setAnimationCurve:[curve intValue]];</div><div class="line">    </div><div class="line">    [<span class="keyword">self</span>.inputProjectView layoutIfNeeded];</div><div class="line">    </div><div class="line">    [<span class="built_in">UIView</span> commitAnimations];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)keyboardWillHide:(<span class="built_in">NSNotification</span> *)notification &#123;</div><div class="line">    </div><div class="line">    <span class="keyword">if</span>([<span class="keyword">self</span>.inputProjectView inputText].length &gt; <span class="number">0</span>) &#123;</div><div class="line">        [<span class="keyword">self</span>.inputProjectView resetText];</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="built_in">CGRect</span> keyboardBounds;</div><div class="line">    [[notification.userInfo valueForKey:<span class="built_in">UIKeyboardFrameEndUserInfoKey</span>] getValue:&amp;keyboardBounds];</div><div class="line">    <span class="built_in">NSNumber</span> *duration = [notification.userInfo objectForKey:<span class="built_in">UIKeyboardAnimationDurationUserInfoKey</span>];</div><div class="line">    <span class="built_in">NSNumber</span> *curve = [notification.userInfo objectForKey:<span class="built_in">UIKeyboardAnimationCurveUserInfoKey</span>];</div><div class="line">    </div><div class="line">    keyboardBounds = [<span class="keyword">self</span>.view convertRect:keyboardBounds toView:<span class="literal">nil</span>];</div><div class="line">    </div><div class="line">    [<span class="keyword">self</span>.inputProjectView mas_updateConstraints:^(MASConstraintMaker *make) &#123;</div><div class="line">        <span class="keyword">if</span> (@available(iOS <span class="number">11.0</span>, *)) &#123;</div><div class="line">            make.bottom.equalTo(<span class="keyword">self</span>.view).offset(<span class="keyword">self</span>.view.safeAreaInsets.bottom+<span class="number">88</span>);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            make.bottom.equalTo(<span class="keyword">self</span>.view).offset(<span class="number">88</span>);</div><div class="line">        &#125;</div><div class="line">        make.height.mas_equalTo(<span class="number">88</span>);</div><div class="line">    &#125;];</div><div class="line">    </div><div class="line">    <span class="comment">//设置动画</span></div><div class="line">    [<span class="built_in">UIView</span> beginAnimations:<span class="literal">nil</span> context:<span class="literal">NULL</span>];</div><div class="line">    [<span class="built_in">UIView</span> setAnimationBeginsFromCurrentState:<span class="literal">YES</span>];</div><div class="line">    [<span class="built_in">UIView</span> setAnimationDuration:[duration doubleValue]];</div><div class="line">    [<span class="built_in">UIView</span> setAnimationCurve:[curve intValue]];</div><div class="line">    </div><div class="line">    [<span class="keyword">self</span>.inputProjectView layoutIfNeeded];</div><div class="line">    </div><div class="line">    [<span class="built_in">UIView</span> commitAnimations];</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><h5 id="切换输入法时，输入框被键盘遮住问题"><a href="#切换输入法时，输入框被键盘遮住问题" class="headerlink" title="切换输入法时，输入框被键盘遮住问题"></a>切换输入法时，输入框被键盘遮住问题</h5><p>在修复此问题后，自测时发现，输入法由简体拼音切换为表情符号时，输入框会被键盘挡住，在代码中打断点发现<code>UIKeyboardWillShowNotification</code>和<code>UIKeyboardWillChangeFrameNotification</code>通知均未被触发，同时对比微信发现，切换输入法时，同时开启了自动校正功能，所以参考添加如下代码：<br></p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">_textView.internalTextView.autocorrectionType = <span class="built_in">UITextAutocorrectionTypeYes</span>;</div></pre></td></tr></table></figure><p></p><p>解决切换输入法时，输入框被键盘遮住的问题。</p><h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>除了上述<code>Table View Cell</code>移动的操作，在项目中还处理了创建事务和事务详情相关的业务。在整个过程中，比较棘手的还是<code>Table View Cell</code>的移动，在开发过程中，有时数据的移动和<code>Table View Cell</code>的移动未对应上，造成<code>Table View Cell</code>布局错乱，排查了很久。在项目开发过程中，还是需要仔细去分析需求。</p><p>文章所对应的<code>Demo</code>请点<a href="https://github.com/leverTsui/LongPressMoveCellDemo" target="_blank" rel="external">这里</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h4&gt;&lt;p&gt;最近参与了事务流程工具化组件的开发，其中有一个模块需要通过长按移动&lt;code&gt;Table View Cells&lt;/code&gt;，来达到调整任务
      
    
    </summary>
    
      <category term="UI" scheme="http://leverTsui.github.io/categories/UI/"/>
    
    
      <category term="UI 长按移动 滚动" scheme="http://leverTsui.github.io/tags/UI-%E9%95%BF%E6%8C%89%E7%A7%BB%E5%8A%A8-%E6%BB%9A%E5%8A%A8/"/>
    
  </entry>
  
  <entry>
    <title>iOS深拷贝和浅拷贝</title>
    <link href="http://leverTsui.github.io/2017/12/14/iOS%E6%B7%B1%E6%8B%B7%E8%B4%9D%E5%92%8C%E6%B5%85%E6%8B%B7%E8%B4%9D/"/>
    <id>http://leverTsui.github.io/2017/12/14/iOS深拷贝和浅拷贝/</id>
    <published>2017-12-14T04:26:00.000Z</published>
    <updated>2017-12-14T04:23:08.000Z</updated>
    
    <content type="html"><![CDATA[<p>在工作中，有时会涉及到深拷贝和浅拷贝的内容，发现有些地方理解的不够透彻，所以在网上搜集资料总结一下，主要分四个方面来介绍下iOS中深拷贝和浅拷贝：</p><ul><li>对象的拷贝；</li><li>集合的拷贝；</li><li>如何对集合进行深拷贝？</li><li>总结<h4 id="对象的拷贝"><a href="#对象的拷贝" class="headerlink" title="对象的拷贝"></a>对象的拷贝</h4>对对象进行拷贝，通过调用<code>copy</code>或<code>mutableCopy</code>方法来实现：</li><li>调用 <code>copy</code>方法返回的对象为不可变对象,需要实现<code>NSCopying</code>协议 ；</li><li>调用<code>mutableCopy</code>方法返回的对象为可变对象，需要实现<code>NSMutableCopying</code>协议 ；</li></ul><p><img src="http://upload-images.jianshu.io/upload_images/117999-adeebf183df99baa.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="object copying"><br>上图是苹果文档中关于对象拷贝的实例图，从图中可知：</p><blockquote><p>浅拷贝：<code>object A</code>和<code>object B</code>及其属性使用同样的内存地址，简单说明的话，可以认为是指针复制；<br>深拷贝：<code>object A</code>和<code>object B</code>及其属性使用不同的内存地址，简单说明的话，可以认为是内容复制。</p></blockquote><p>下面通过分析<code>NSString</code>、<code>NSMutableString</code>、和自定义对象<code>DBTestModel</code>，调用<code>copy</code>和<code>mutableCopy</code>之后，分析其返回的对象及此对象的属性的内存地址来判断其行为是深拷贝还是浅拷贝。</p><h5 id="NSString"><a href="#NSString" class="headerlink" title="NSString"></a>NSString</h5><p><img src="http://upload-images.jianshu.io/upload_images/117999-bcac53e449d8b0a7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="NSString.png"></p><p>通过打印的信息可知：</p><ul><li>对象<code>string</code>调用<code>copy</code>方法后返回的对象<code>copySting</code>，其所对应的内存地址和对象<code>string</code>一致，即为指针复制；</li><li>对象<code>string</code>调用<code>mutableCopy</code>方法后返回的对象<code>mutaCopySting</code>，其所对应的内存地址和对象<code>string</code>不一致，即为指内容复制；</li></ul><h5 id="NSMutableString"><a href="#NSMutableString" class="headerlink" title="NSMutableString"></a>NSMutableString</h5><p><img src="http://upload-images.jianshu.io/upload_images/117999-0eab0dce73bccbec.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="NSMutableString.png"></p><p>通过打印的信息可知：</p><ul><li>对象<code>mutaString</code>调用<code>copy</code>方法后返回的对象<code>copyMutaString</code>，其所对应的内存地址和对象<code>mutaString</code>不一致，即为内容复制；</li><li>对象<code>mutaString</code>调用<code>mutableCopy</code>方法后返回的对象<code>mutaCopyMutaString</code>，其所对应的内存地址和对象<code>mutaString</code>不一致，即为指内容复制；</li></ul><h5 id="DBTestModel"><a href="#DBTestModel" class="headerlink" title="DBTestModel"></a>DBTestModel</h5><p>下面为自定义的对象’DBTestModel’:</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></div><div class="line"><span class="meta">#import <span class="meta-string">&lt;Mantle/Mantle.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">DBTestModel</span> : <span class="title">MTLModel</span></span></div><div class="line"></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *text;</div><div class="line"></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSArray</span> *sourceArray;</div><div class="line"></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSMutableArray</span> *mutableArray;</div><div class="line"></div><div class="line">- (<span class="keyword">instancetype</span>)initWithText:(<span class="built_in">NSString</span> *)text</div><div class="line">                 sourceArray:(<span class="built_in">NSArray</span> *)sourceArray</div><div class="line">                mutableArray:(<span class="built_in">NSMutableArray</span> *)mutableArray;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure><p>定义了三个属性，<code>text</code>、<code>sourceArray</code>、<code>mutableArray</code>。<br></p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)testCustomObject &#123;</div><div class="line">    <span class="built_in">NSMutableArray</span> *mutableArray = [<span class="built_in">NSMutableArray</span> array];</div><div class="line">    DBTestModel *model = [[DBTestModel alloc] initWithText:<span class="string">@"text"</span></div><div class="line">                                               sourceArray:@[<span class="string">@"test1"</span>,<span class="string">@"test2"</span>]</div><div class="line">                                              mutableArray:mutableArray];</div><div class="line">    DBTestModel *copyModel = [model <span class="keyword">copy</span>];</div><div class="line">    DBTestModel *mutaCopyModel = [model mutableCopy];</div><div class="line">    </div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"DBTestModel memory address"</span>);</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"original   :%p"</span>, model);</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"copy       :%p"</span>, copyModel);</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"mutableCopy:%p"</span>, mutaCopyModel);</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"\n"</span>);</div><div class="line">    </div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"text memory address"</span>);</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"original   :%p"</span>, model.text);</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"copy       :%p"</span>, copyModel.text);</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"mutableCopy:%p"</span>, mutaCopyModel.text);</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"\n"</span>);</div><div class="line">    </div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"sourceArray memory address"</span>);</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"original   :%p"</span>, model.sourceArray);</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"copy       :%p"</span>, copyModel.sourceArray);</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"mutableCopy:%p"</span>, mutaCopyModel.sourceArray);</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"\n"</span>);</div><div class="line">    </div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"mutableArray memory address"</span>);</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"original   :%p"</span>, model.mutableArray);</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"copy       :%p"</span>, copyModel.mutableArray);</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"mutableCopy:%p"</span>, mutaCopyModel.mutableArray);</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"\n"</span>); </div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><p>打印结果如下：<br><img src="http://upload-images.jianshu.io/upload_images/117999-7edadb3411c425dd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"><br>分析其打印数据可知：</p><ul><li>除<code>DBTestModel</code>实例对象中的属性<code>text</code>和<code>sourceArray</code>调用<code>copy</code>后，没有产生一个新的对象，为指针复制，其余均为内容复制。</li></ul><h4 id="集合的拷贝"><a href="#集合的拷贝" class="headerlink" title="集合的拷贝"></a>集合的拷贝</h4><p><img src="http://upload-images.jianshu.io/upload_images/117999-c329ce5e7a3eb4e5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><h5 id="不可变集合NSArray"><a href="#不可变集合NSArray" class="headerlink" title="不可变集合NSArray"></a>不可变集合<code>NSArray</code></h5><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)testCollectiveCopy &#123;</div><div class="line">    <span class="built_in">NSMutableArray</span> *mutableArray1 = [<span class="built_in">NSMutableArray</span> array];</div><div class="line">    DBTestModel *model1 = [[DBTestModel alloc] initWithText:<span class="string">@"text"</span></div><div class="line">                                               sourceArray:@[<span class="string">@"test1"</span>,<span class="string">@"test2"</span>]</div><div class="line">                                              mutableArray:mutableArray1];</div><div class="line">    </div><div class="line">    <span class="built_in">NSMutableArray</span> *mutableArray2 = [<span class="built_in">NSMutableArray</span> array];</div><div class="line">    DBTestModel *model2 = [[DBTestModel alloc] initWithText:<span class="string">@"text"</span></div><div class="line">                                                sourceArray:@[<span class="string">@"test1"</span>,<span class="string">@"test2"</span>]</div><div class="line">                                               mutableArray:mutableArray2];</div><div class="line">    </div><div class="line">    <span class="built_in">NSMutableArray</span> *mutableArray3 = [<span class="built_in">NSMutableArray</span> array];</div><div class="line">    DBTestModel *model3 = [[DBTestModel alloc] initWithText:<span class="string">@"text"</span></div><div class="line">                                                sourceArray:@[<span class="string">@"test1"</span>,<span class="string">@"test2"</span>]</div><div class="line">                                               mutableArray:mutableArray3];</div><div class="line">    <span class="built_in">NSArray</span> *array = @[model1,model2,model3];</div><div class="line">    <span class="built_in">NSArray</span> *copyArray = [array <span class="keyword">copy</span>];</div><div class="line">    <span class="built_in">NSMutableArray</span> *mutaCopyArray = [array mutableCopy];</div><div class="line"></div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"\nNSArray memory address\noriginal   :%p\ncopy       :%p\nmutableCopy:%p\n"</span>,</div><div class="line">          array,copyArray,mutaCopyArray);</div><div class="line"> </div><div class="line">    DBTestModel *firstCopyModel = [copyArray firstObject];</div><div class="line">    DBTestModel *firstMutableCopyModel = [mutaCopyArray firstObject];</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"\nDBTestModel memory address\noriginal   :%p\ncopy       :%p\nmutableCopy:%p\n"</span>,</div><div class="line">          model1,firstCopyModel,firstMutableCopyModel);</div><div class="line"> </div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"\nDBTestModel sourceArray memory address\noriginal   :%p\ncopy       :%p\nmutableCopy:%p\n"</span>,</div><div class="line">          model1.sourceArray,firstCopyModel.sourceArray,firstMutableCopyModel.sourceArray); </div><div class="line">&#125;</div></pre></td></tr></table></figure><p>打印结果如下：</p><p><img src="http://upload-images.jianshu.io/upload_images/117999-b541a083c1018ea6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="NSArray.png"></p><p>分析其打印数据可知：</p><ul><li>除<code>NSArray</code>实例对象调用<code>mutableCopy</code>方法为内容复制外，其余的均为指针拷贝。</li></ul><h5 id="可变集合NSMutableArray"><a href="#可变集合NSMutableArray" class="headerlink" title="可变集合NSMutableArray"></a>可变集合<code>NSMutableArray</code></h5><p>测试代码如下：<br></p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)testCollectiveMutacopy &#123;</div><div class="line">    <span class="built_in">NSMutableArray</span> *mutableArray1 = [<span class="built_in">NSMutableArray</span> array];</div><div class="line">    DBTestModel *model1 = [[DBTestModel alloc] initWithText:<span class="string">@"text"</span></div><div class="line">                                                sourceArray:@[<span class="string">@"test1"</span>,<span class="string">@"test2"</span>]</div><div class="line">                                               mutableArray:mutableArray1];</div><div class="line">    </div><div class="line">    <span class="built_in">NSMutableArray</span> *mutableArray2 = [<span class="built_in">NSMutableArray</span> array];</div><div class="line">    DBTestModel *model2 = [[DBTestModel alloc] initWithText:<span class="string">@"text"</span></div><div class="line">                                                sourceArray:@[<span class="string">@"test1"</span>,<span class="string">@"test2"</span>]</div><div class="line">                                               mutableArray:mutableArray2];</div><div class="line">    </div><div class="line">    <span class="built_in">NSMutableArray</span> *mutableArray3 = [<span class="built_in">NSMutableArray</span> array];</div><div class="line">    DBTestModel *model3 = [[DBTestModel alloc] initWithText:<span class="string">@"text"</span></div><div class="line">                                                sourceArray:@[<span class="string">@"test1"</span>,<span class="string">@"test2"</span>]</div><div class="line">                                               mutableArray:mutableArray3];</div><div class="line">    </div><div class="line">    <span class="built_in">NSArray</span> *array1 = @[model1,model2,model3];</div><div class="line">    <span class="built_in">NSMutableArray</span> *mutaArray = [<span class="built_in">NSMutableArray</span> arrayWithArray:array1];</div><div class="line">    <span class="built_in">NSMutableArray</span> *copyMutaArray = [mutaArray <span class="keyword">copy</span>];</div><div class="line">    <span class="built_in">NSMutableArray</span> *mutaCopyMutaArray= [mutaArray mutableCopy];</div><div class="line">    </div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"\nNSMutableArray memory address\noriginal   :%p\ncopy       :%p\nmutableCopy:%p\n"</span>,</div><div class="line">          mutaArray,copyMutaArray,mutaCopyMutaArray);</div><div class="line">    </div><div class="line">    DBTestModel *firstCopyModel = [copyMutaArray firstObject];</div><div class="line">    DBTestModel *firstMutableCopyModel = [mutaCopyMutaArray firstObject];</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"\nDBTestModel memory address\noriginal   :%p\ncopy       :%p\nmutableCopy:%p\n"</span>,</div><div class="line">          model1,firstCopyModel,firstMutableCopyModel);</div><div class="line">    </div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"\nDBTestModel sourceArray memory address\noriginal   :%p\ncopy       :%p\nmutableCopy:%p\n"</span>,</div><div class="line">          model1.sourceArray,firstCopyModel.sourceArray,firstMutableCopyModel.sourceArray);</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><p>测试结果如下：</p><p><img src="http://upload-images.jianshu.io/upload_images/117999-50c419ac45f0dd51.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="NSMutableArray.png"></p><p>分析其打印数据可知：<br>除<code>NSMutableArray</code>实例对象调用<code>copy</code>和<code>mutableCopy</code>方法为内容复制外，数组内容的元素均为指针拷贝。<br>结合上述测试代码得出的测试数据，得出如下的表格：<br><img src="http://upload-images.jianshu.io/upload_images/117999-cc6317d514f6c864.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p>从上图可以看出，<code>NSArray</code>或<code>NSMutableArray</code>对象调用<code>copy</code>或<code>mutableCopy</code>时，得到的集合中的元素均为指针拷贝，如果想要实现集合对象的深拷贝，应该怎么办呢？</p><ul><li><h4 id="如何对集合进行深拷贝？"><a href="#如何对集合进行深拷贝？" class="headerlink" title="如何对集合进行深拷贝？"></a>如何对集合进行深拷贝？</h4></li><li><h5 id="集合的单层深复制-one-level-deep-copy"><a href="#集合的单层深复制-one-level-deep-copy" class="headerlink" title="集合的单层深复制 (one-level-deep copy)"></a>集合的单层深复制 (one-level-deep copy)</h5>可以用 <code>initWithArray:copyItems:</code> 将第二个参数设置为YES即可深复制，如<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">NSArray *copyArray = [[NSArray alloc] initWithArray:array copyItems:YES];</div></pre></td></tr></table></figure></li></ul><p>如果你用这种方法深复制，集合里的每个对象都会收到 copyWithZone: 消息。同时集合里的对象需遵循 NSCopying 协议，否则会崩溃。<br><img src="http://upload-images.jianshu.io/upload_images/117999-8d496f137b153a4a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p>得到的结果如下：</p><p><img src="http://upload-images.jianshu.io/upload_images/117999-a48a67077a1f4d4a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p>从打印结果可以看出，拷贝后和拷贝前的数组中的<code>DBTestModel</code>对象的<code>sourceArray</code>的内存地址是相同的，这种拷贝方式只能够提供一层内存拷贝(<code>one-level-deep copy</code>)，而非真正的深复制。</p><ul><li><h5 id="A-true-deep-copy"><a href="#A-true-deep-copy" class="headerlink" title="A true deep copy"></a>A true deep copy</h5>使用归档来实现:</li></ul><pre><code class="objectivec"><span class="built_in">NSArray</span> *copyArray = [<span class="built_in">NSKeyedUnarchiver</span> unarchiveObjectWithData:       [<span class="built_in">NSKeyedArchiver</span> archivedDataWithRootObject:array]];</code></pre><p>####小结<br>在项目中遇到需要需要对对象进行拷贝时，需要理解以下两点：<br>1、对系统自带的不可变对象进行<code>copy</code>时，为指针复制；<br>2、对集合类对象进行<code>copy</code>或<code>mutableCopy</code>时，集合类的元素均为指针复制；<br>3、如只需对集合进行单层深拷贝，可以使用<code>initWithArray:copyItems:</code>类似的方法，将第二个参数设为<code>YES</code>来实现，如需实现集合的完全复制，可以使用归解档来实现；<br>4、第三方库<code>Mantle</code>中的<code>MTLModel</code>类有实现<code>NSCoding</code>和<code>NSCopying</code>协议，自定义的类继承<code>MTLModel</code>类即可实现<code>NSCoding</code>和<code>NSCopying</code>协议。</p><h4 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h4><p><a href="https://developer.apple.com/library/content/documentation/General/Conceptual/DevPedia-CocoaCore/ObjectCopying.html" target="_blank" rel="external">Object copying</a><br><a href="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/Collections/Articles/Copying.html" target="_blank" rel="external">Copying Collections</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;在工作中，有时会涉及到深拷贝和浅拷贝的内容，发现有些地方理解的不够透彻，所以在网上搜集资料总结一下，主要分四个方面来介绍下iOS中深拷贝和浅拷贝：&lt;/p&gt;&lt;ul&gt;&lt;li&gt;对象的拷贝；&lt;/li&gt;&lt;li&gt;集合的拷贝；&lt;/li&gt;&lt;li&gt;如何对集合进行深拷贝？&lt;/li&gt;&lt;li&gt;总结
      
    
    </summary>
    
      <category term="基础知识" scheme="http://leverTsui.github.io/categories/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/"/>
    
    
      <category term="Object-C" scheme="http://leverTsui.github.io/tags/Object-C/"/>
    
  </entry>
  
  <entry>
    <title>MBProgressHUD 源码分析</title>
    <link href="http://leverTsui.github.io/2017/11/08/MBProgressHUD%20%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    <id>http://leverTsui.github.io/2017/11/08/MBProgressHUD 源码分析/</id>
    <published>2017-11-08T14:26:00.000Z</published>
    <updated>2017-11-08T14:35:48.000Z</updated>
    
    <content type="html"><![CDATA[<p>在项目中经常会使用<code>MBProgressHUD</code>来实现弹窗提醒，所有来分析下<code>MBProgressHUD</code>这个三方库的代码。所分析的源码版本号为1.0.0。</p><hr><p>这篇总结主要分三个部分来介绍分析这个框架：</p><ul><li>代码结构</li><li>方法调用流程图</li><li>方法内部实现</li></ul><hr><h5 id="代码结构"><a href="#代码结构" class="headerlink" title="代码结构"></a>代码结构</h5><h6 id="类图"><a href="#类图" class="headerlink" title="类图"></a>类图</h6><p><img src="http://upload-images.jianshu.io/upload_images/117999-5da3f0778692f17f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="MBProgressHUD.png"></p><h5 id="核心API"><a href="#核心API" class="headerlink" title="核心API"></a>核心API</h5><h6 id="属性"><a href="#属性" class="headerlink" title="属性"></a>属性</h6><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * 用来推迟HUD的显示，避免HUD显示时间过短，出现一闪而逝的情况，默认值为0。</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">assign</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSTimeInterval</span> graceTime;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> *  HUD最短显示时间，单位为s，默认值为0。 </span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">assign</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSTimeInterval</span> minShowTime;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * HUD隐藏时，将其从父视图上移除 。默认值为NO </span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">assign</span>, <span class="keyword">nonatomic</span>) <span class="built_in">BOOL</span> removeFromSuperViewOnHide; </div><div class="line"></div><div class="line"><span class="comment">/** </span></div><div class="line"><span class="comment"> * HUD显示类型，默认为 MBProgressHUDModeIndeterminate.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">assign</span>, <span class="keyword">nonatomic</span>) MBProgressHUDMode mode;</div></pre></td></tr></table></figure><h6 id="类方法"><a href="#类方法" class="headerlink" title="类方法"></a>类方法</h6><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 创建HUD,添加到提供的视图上并显示</span></div><div class="line"><span class="comment"> */</span></div><div class="line">+ (<span class="keyword">instancetype</span>)showHUDAddedTo:(<span class="built_in">UIView</span> *)view animated:(<span class="built_in">BOOL</span>)animated;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 找到最上层的HUD,并隐藏。</span></div><div class="line"><span class="comment"> */</span></div><div class="line">+ (<span class="built_in">BOOL</span>)hideHUDForView:(<span class="built_in">UIView</span> *)view animated:(<span class="built_in">BOOL</span>)animated;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 在传入的View上找到最上层的HUD并隐藏此HUD</span></div><div class="line"><span class="comment"> */</span></div><div class="line">+ (<span class="keyword">nullable</span> MBProgressHUD *)HUDForView:(<span class="built_in">UIView</span> *)view;</div></pre></td></tr></table></figure><h6 id="实例方法"><a href="#实例方法" class="headerlink" title="实例方法"></a>实例方法</h6><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 构造函数，用来初始化HUD</span></div><div class="line"><span class="comment"> */</span></div><div class="line">- (<span class="keyword">instancetype</span>)initWithView:(<span class="built_in">UIView</span> *)view;</div><div class="line"></div><div class="line"><span class="comment">/** </span></div><div class="line"><span class="comment"> * 显示HUD</span></div><div class="line"><span class="comment"> */</span></div><div class="line">- (<span class="keyword">void</span>)showAnimated:(<span class="built_in">BOOL</span>)animated;</div><div class="line"></div><div class="line"><span class="comment">/** </span></div><div class="line"><span class="comment"> * 隐藏HUD</span></div><div class="line"><span class="comment"> */</span></div><div class="line">- (<span class="keyword">void</span>)hideAnimated:(<span class="built_in">BOOL</span>)animated;</div></pre></td></tr></table></figure><h5 id="方法调用流程图"><a href="#方法调用流程图" class="headerlink" title="方法调用流程图"></a>方法调用流程图</h5><p>从<code>MBProgressHUD</code>提供的主要接口可以看出，主要有显示HUD和隐藏HUD这两个功能，一步步追溯，得出的方法调用流程图如下：<br><img src="http://upload-images.jianshu.io/upload_images/117999-4c522bd388a1a65a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="MBProgressHUD流程图.png"></p><h5 id="方法内部实现"><a href="#方法内部实现" class="headerlink" title="方法内部实现"></a>方法内部实现</h5><p>方法的内部实现主要从两个方面来分析，显示HUD和隐藏HUD。</p><h6 id="显示HUD"><a href="#显示HUD" class="headerlink" title="显示HUD"></a>显示HUD</h6><p>首先是MBProgressHUD的构造方法<br></p><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">+ (<span class="keyword">instancetype</span>)showHUDAddedTo:(<span class="built_in">UIView</span> *)view animated:(<span class="built_in">BOOL</span>)animated &#123;</div><div class="line">    <span class="comment">//初始化MBProgressHUD</span></div><div class="line">    MBProgressHUD *hud = [[<span class="keyword">self</span> alloc] initWithView:view];</div><div class="line">    hud.removeFromSuperViewOnHide = <span class="literal">YES</span>;</div><div class="line">    [view addSubview:hud];</div><div class="line">    [hud showAnimated:animated];</div><div class="line">    [[<span class="built_in">UINavigationBar</span> appearance] setBarTintColor:<span class="literal">nil</span>];</div><div class="line">    <span class="keyword">return</span> hud;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><p>首先进入<code>- (id)initWithView:(UIView *)view</code>方法，再进入<code>- (instancetype)initWithFrame:(CGRect)frame</code>方法，最后调用<code>- (void)commonInit</code>方法，进行属性的初始化和添加子视图。<br></p><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)commonInit &#123;</div><div class="line">    <span class="comment">// Set default values for properties</span></div><div class="line">    _animationType = MBProgressHUDAnimationFade;</div><div class="line">    _mode = MBProgressHUDModeIndeterminate;</div><div class="line">    _margin = <span class="number">20.0</span>f;</div><div class="line">    _opacity = <span class="number">1.</span>f;</div><div class="line">    _defaultMotionEffectsEnabled = <span class="literal">YES</span>;</div><div class="line"></div><div class="line">    <span class="comment">// Default color, depending on the current iOS version</span></div><div class="line">    <span class="built_in">BOOL</span> isLegacy = kCFCoreFoundationVersionNumber &lt; kCFCoreFoundationVersionNumber_iOS_7_0;</div><div class="line">    _contentColor = isLegacy ? [<span class="built_in">UIColor</span> whiteColor] : [<span class="built_in">UIColor</span> colorWithWhite:<span class="number">0.</span>f alpha:<span class="number">0.7</span>f];</div><div class="line">    <span class="comment">// Transparent background</span></div><div class="line">    <span class="keyword">self</span>.opaque = <span class="literal">NO</span>;</div><div class="line">    <span class="keyword">self</span>.backgroundColor = [<span class="built_in">UIColor</span> clearColor];</div><div class="line">    <span class="comment">// Make it invisible for now</span></div><div class="line">    <span class="keyword">self</span>.alpha = <span class="number">0.0</span>f;</div><div class="line">    <span class="keyword">self</span>.autoresizingMask = <span class="built_in">UIViewAutoresizingFlexibleWidth</span> | <span class="built_in">UIViewAutoresizingFlexibleHeight</span>;</div><div class="line">    <span class="keyword">self</span>.layer.allowsGroupOpacity = <span class="literal">NO</span>;</div><div class="line">    <span class="comment">//添加子视图</span></div><div class="line">    [<span class="keyword">self</span> setupViews];</div><div class="line">    <span class="comment">//更新指示器</span></div><div class="line">    [<span class="keyword">self</span> updateIndicators];</div><div class="line">    [<span class="keyword">self</span> registerForNotifications];</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><p>添加子视图都是常见的方式，让视图跟随陀螺仪运动，这个之前没有接触过，后续需要了解下。<br></p><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)updateBezelMotionEffects &#123;</div><div class="line"><span class="meta">#if __IPHONE_OS_VERSION_MAX_ALLOWED &gt;= 70000 || TARGET_OS_TV</span></div><div class="line">    MBBackgroundView *bezelView = <span class="keyword">self</span>.bezelView;</div><div class="line">    <span class="keyword">if</span> (![bezelView respondsToSelector:<span class="keyword">@selector</span>(addMotionEffect:)]) <span class="keyword">return</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.defaultMotionEffectsEnabled) &#123;</div><div class="line">        <span class="built_in">CGFloat</span> effectOffset = <span class="number">10.</span>f;</div><div class="line">        <span class="built_in">UIInterpolatingMotionEffect</span> *effectX = [[<span class="built_in">UIInterpolatingMotionEffect</span> alloc] initWithKeyPath:<span class="string">@"center.x"</span> type:<span class="built_in">UIInterpolatingMotionEffectTypeTiltAlongHorizontalAxis</span>];</div><div class="line">        effectX.maximumRelativeValue = @(effectOffset);</div><div class="line">        effectX.minimumRelativeValue = @(-effectOffset);</div><div class="line"></div><div class="line">        <span class="built_in">UIInterpolatingMotionEffect</span> *effectY = [[<span class="built_in">UIInterpolatingMotionEffect</span> alloc] initWithKeyPath:<span class="string">@"center.y"</span> type:<span class="built_in">UIInterpolatingMotionEffectTypeTiltAlongVerticalAxis</span>];</div><div class="line">        effectY.maximumRelativeValue = @(effectOffset);</div><div class="line">        effectY.minimumRelativeValue = @(-effectOffset);</div><div class="line"></div><div class="line">        <span class="built_in">UIMotionEffectGroup</span> *group = [[<span class="built_in">UIMotionEffectGroup</span> alloc] init];</div><div class="line">        group.motionEffects = @[effectX, effectY];</div><div class="line"></div><div class="line">        [bezelView addMotionEffect:group];</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="built_in">NSArray</span> *effects = [bezelView motionEffects];</div><div class="line">        <span class="keyword">for</span> (<span class="built_in">UIMotionEffect</span> *effect <span class="keyword">in</span> effects) &#123;</div><div class="line">            [bezelView removeMotionEffect:effect];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"><span class="meta">#endif</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><p>再主要看下更新指示器的代码。<br></p><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)updateIndicators &#123; </div><div class="line">    <span class="built_in">UIView</span> *indicator = <span class="keyword">self</span>.indicator;</div><div class="line">    <span class="built_in">BOOL</span> isActivityIndicator = [indicator isKindOfClass:[<span class="built_in">UIActivityIndicatorView</span> <span class="keyword">class</span>]];</div><div class="line">    <span class="built_in">BOOL</span> isRoundIndicator = [indicator isKindOfClass:[MBRoundProgressView <span class="keyword">class</span>]];</div><div class="line"></div><div class="line">    MBProgressHUDMode mode = <span class="keyword">self</span>.mode;</div><div class="line">    <span class="comment">//菊花动画</span></div><div class="line">    <span class="keyword">if</span> (mode == MBProgressHUDModeIndeterminate) &#123;</div><div class="line">        <span class="keyword">if</span> (!isActivityIndicator) &#123;</div><div class="line">            <span class="comment">// Update to indeterminate indicator</span></div><div class="line">            [indicator removeFromSuperview];</div><div class="line">            indicator = [[<span class="built_in">UIActivityIndicatorView</span> alloc] initWithActivityIndicatorStyle:<span class="built_in">UIActivityIndicatorViewStyleWhiteLarge</span>];</div><div class="line">            [(<span class="built_in">UIActivityIndicatorView</span> *)indicator startAnimating];</div><div class="line">            [<span class="keyword">self</span>.bezelView addSubview:indicator];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//水平进度条动画</span></div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (mode == MBProgressHUDModeDeterminateHorizontalBar) &#123;</div><div class="line">        <span class="comment">// Update to bar determinate indicator</span></div><div class="line">        [indicator removeFromSuperview];</div><div class="line">        indicator = [[MBBarProgressView alloc] init];</div><div class="line">        [<span class="keyword">self</span>.bezelView addSubview:indicator];</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//圆形进度动画</span></div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (mode == MBProgressHUDModeDeterminate || mode == MBProgressHUDModeAnnularDeterminate) &#123;</div><div class="line">        <span class="keyword">if</span> (!isRoundIndicator) &#123;</div><div class="line">            <span class="comment">// Update to determinante indicator</span></div><div class="line">            [indicator removeFromSuperview];</div><div class="line">            indicator = [[MBRoundProgressView alloc] init];</div><div class="line">            [<span class="keyword">self</span>.bezelView addSubview:indicator];</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//环形动画</span></div><div class="line">        <span class="keyword">if</span> (mode == MBProgressHUDModeAnnularDeterminate) &#123;</div><div class="line">            [(MBRoundProgressView *)indicator setAnnular:<span class="literal">YES</span>];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//自定义动画</span></div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (mode == MBProgressHUDModeCustomView &amp;&amp; <span class="keyword">self</span>.customView != indicator) &#123;</div><div class="line">        <span class="comment">// Update custom view indicator</span></div><div class="line">        [indicator removeFromSuperview];</div><div class="line">        indicator = <span class="keyword">self</span>.customView;</div><div class="line">        [<span class="keyword">self</span>.bezelView addSubview:indicator];</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//只显示文本</span></div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (mode == MBProgressHUDModeText) &#123;</div><div class="line">        [indicator removeFromSuperview];</div><div class="line">        indicator = <span class="literal">nil</span>;</div><div class="line">    &#125;</div><div class="line">    indicator.translatesAutoresizingMaskIntoConstraints = <span class="literal">NO</span>;</div><div class="line">    <span class="keyword">self</span>.indicator = indicator;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ([indicator respondsToSelector:<span class="keyword">@selector</span>(setProgress:)]) &#123;</div><div class="line">        [(<span class="keyword">id</span>)indicator setValue:@(<span class="keyword">self</span>.progress) forKey:<span class="string">@"progress"</span>];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    [indicator setContentCompressionResistancePriority:<span class="number">998.</span>f forAxis:<span class="built_in">UILayoutConstraintAxisHorizontal</span>];</div><div class="line">    [indicator setContentCompressionResistancePriority:<span class="number">998.</span>f forAxis:<span class="built_in">UILayoutConstraintAxisVertical</span>];</div><div class="line"></div><div class="line">    [<span class="keyword">self</span> updateViewsForColor:<span class="keyword">self</span>.contentColor];</div><div class="line">    [<span class="keyword">self</span> setNeedsUpdateConstraints];</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><p>在这个方法中，主要是根据显示的模式，将不同的<code>indicator</code>视图赋值给<code>indicator</code>属性。更新完指示器后，就是开始将视图显示在界面上。调用的是<code>- (void)showAnimated:(BOOL)animated</code>方法。<br></p><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">- (<span class="keyword">void</span>)showAnimated:(<span class="built_in">BOOL</span>)animated &#123;</div><div class="line">    <span class="comment">//保证当前线程是主线程</span></div><div class="line">    MBMainThreadAssert();</div><div class="line">    [<span class="keyword">self</span>.minShowTimer invalidate];</div><div class="line">    <span class="keyword">self</span>.useAnimation = animated;</div><div class="line">    <span class="keyword">self</span>.finished = <span class="literal">NO</span>;</div><div class="line">    <span class="comment">// 如果设置了宽限时间，则推迟HUD的显示</span></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.graceTime &gt; <span class="number">0.0</span>) &#123;</div><div class="line">        <span class="built_in">NSTimer</span> *timer = [<span class="built_in">NSTimer</span> timerWithTimeInterval:<span class="keyword">self</span>.graceTime</div><div class="line">                                                 target:<span class="keyword">self</span></div><div class="line">                                               selector:<span class="keyword">@selector</span>(handleGraceTimer:)</div><div class="line">                                               userInfo:<span class="literal">nil</span></div><div class="line">                                                repeats:<span class="literal">NO</span>];</div><div class="line">        <span class="comment">//默认把你的Timer以NSDefaultRunLoopMode添加到MainRunLoop上，而当当前视图在滚动时，当前的MainRunLoop是处于UITrackingRunLoopMode的模式下，在这个模式下，是不会处理NSDefaultRunLoopMode的消息，要想在scrollView滚动的同时Timer也执行的话，我们需要将Timer以NSRunLoopCommonModes的模式注册到当前RunLoop中.</span></div><div class="line">        [[<span class="built_in">NSRunLoop</span> currentRunLoop] addTimer:timer forMode:<span class="built_in">NSRunLoopCommonModes</span>];</div><div class="line">        <span class="keyword">self</span>.graceTimer = timer;</div><div class="line">    &#125; </div><div class="line">    <span class="comment">// ... otherwise show the HUD immediately</span></div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        [<span class="keyword">self</span> showUsingAnimation:<span class="keyword">self</span>.useAnimation];</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><p>在<code>- (void)showAnimated:(BOOL)animated</code>方法中，主要做的是判断是否设置了推迟显示HUD的时间，如果设置了，就推迟设置的时间再显示。最后，执行<code>- (void)showUsingAnimation:(BOOL)animated</code>方法。<br></p><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">- (<span class="keyword">void</span>)showUsingAnimation:(<span class="built_in">BOOL</span>)animated &#123;</div><div class="line">    <span class="comment">// Cancel any previous animations</span></div><div class="line">    [<span class="keyword">self</span>.bezelView.layer removeAllAnimations];</div><div class="line">    [<span class="keyword">self</span>.backgroundView.layer removeAllAnimations];</div><div class="line"></div><div class="line">    <span class="comment">// Cancel any scheduled hideDelayed: calls</span></div><div class="line">    [<span class="keyword">self</span>.hideDelayTimer invalidate];</div><div class="line">    <span class="comment">//记录当前显示的时间，在HUD隐藏时，比较HUD显示到HUD隐藏之间的间隔与最小显示时间，</span></div><div class="line">    <span class="comment">//如果小于，继续显示，直到显示时间等于最小显示时间，再隐藏HUD</span></div><div class="line">    <span class="keyword">self</span>.showStarted = [<span class="built_in">NSDate</span> date];</div><div class="line">    <span class="keyword">self</span>.alpha = <span class="number">1.</span>f;</div><div class="line"></div><div class="line">    <span class="comment">// Needed in case we hide and re-show with the same NSProgress object attached.</span></div><div class="line">    <span class="comment">//好像是通过这个去刷新进度，这个需要再查下。</span></div><div class="line">    [<span class="keyword">self</span> setNSProgressDisplayLinkEnabled:<span class="literal">YES</span>];</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (animated) &#123;</div><div class="line">        [<span class="keyword">self</span> animateIn:<span class="literal">YES</span> withType:<span class="keyword">self</span>.animationType completion:<span class="literal">NULL</span>];</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="meta">#pragma clang diagnostic push</span></div><div class="line"><span class="meta">#pragma clang diagnostic ignored <span class="meta-string">"-Wdeprecated-declarations"</span></span></div><div class="line">        <span class="keyword">self</span>.bezelView.alpha = <span class="keyword">self</span>.opacity;</div><div class="line"><span class="meta">#pragma clang diagnostic pop</span></div><div class="line">        <span class="keyword">self</span>.backgroundView.alpha = <span class="number">1.</span>f;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><p>最后执行<code>- (void)animateIn:(BOOL)animatingIn withType:(MBProgressHUDAnimation)type completion:(void(^)(BOOL finished))completion</code>方法，这个方法显示和隐藏均会调用。<br></p><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//这个方法主要对self.bezelView视图进行动画</span></div><div class="line">- (<span class="keyword">void</span>)animateIn:(<span class="built_in">BOOL</span>)animatingIn withType:(MBProgressHUDAnimation)type completion:(<span class="keyword">void</span>(^)(<span class="built_in">BOOL</span> finished))completion &#123;</div><div class="line">    <span class="comment">// Automatically determine the correct zoom animation type</span></div><div class="line">    <span class="keyword">if</span> (type == MBProgressHUDAnimationZoom) &#123;</div><div class="line">        type = animatingIn ? MBProgressHUDAnimationZoomIn : MBProgressHUDAnimationZoomOut;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="built_in">CGAffineTransform</span> small = <span class="built_in">CGAffineTransformMakeScale</span>(<span class="number">0.5</span>f, <span class="number">0.5</span>f);</div><div class="line">    <span class="built_in">CGAffineTransform</span> large = <span class="built_in">CGAffineTransformMakeScale</span>(<span class="number">1.5</span>f, <span class="number">1.5</span>f);</div><div class="line"></div><div class="line">    <span class="comment">// Set starting state</span></div><div class="line">    <span class="built_in">UIView</span> *bezelView = <span class="keyword">self</span>.bezelView;</div><div class="line">    <span class="keyword">if</span> (animatingIn &amp;&amp; bezelView.alpha == <span class="number">0.</span>f &amp;&amp; type == MBProgressHUDAnimationZoomIn) &#123;</div><div class="line">        bezelView.transform = small;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (animatingIn &amp;&amp; bezelView.alpha == <span class="number">0.</span>f &amp;&amp; type == MBProgressHUDAnimationZoomOut) &#123;</div><div class="line">        bezelView.transform = large;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 使用动画</span></div><div class="line">    dispatch_block_t animations = ^&#123;</div><div class="line">        <span class="keyword">if</span> (animatingIn) &#123;</div><div class="line">            bezelView.transform = <span class="built_in">CGAffineTransformIdentity</span>;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!animatingIn &amp;&amp; type == MBProgressHUDAnimationZoomIn) &#123;</div><div class="line">            bezelView.transform = large;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!animatingIn &amp;&amp; type == MBProgressHUDAnimationZoomOut) &#123;</div><div class="line">            bezelView.transform = small;</div><div class="line">        &#125;</div><div class="line"><span class="meta">#pragma clang diagnostic push</span></div><div class="line"><span class="meta">#pragma clang diagnostic ignored <span class="meta-string">"-Wdeprecated-declarations"</span></span></div><div class="line">        bezelView.alpha = animatingIn ? <span class="keyword">self</span>.opacity : <span class="number">0.</span>f;</div><div class="line"><span class="meta">#pragma clang diagnostic pop</span></div><div class="line">        <span class="keyword">self</span>.backgroundView.alpha = animatingIn ? <span class="number">1.</span>f : <span class="number">0.</span>f;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="comment">// Spring animations are nicer, but only available on iOS 7+</span></div><div class="line"><span class="meta">#if __IPHONE_OS_VERSION_MAX_ALLOWED &gt;= 70000 || TARGET_OS_TV</span></div><div class="line">    <span class="keyword">if</span> (kCFCoreFoundationVersionNumber &gt;= kCFCoreFoundationVersionNumber_iOS_7_0) &#123;</div><div class="line">        [<span class="built_in">UIView</span> animateWithDuration:<span class="number">0.3</span> delay:<span class="number">0.</span> usingSpringWithDamping:<span class="number">1.</span>f initialSpringVelocity:<span class="number">0.</span>f options:<span class="built_in">UIViewAnimationOptionBeginFromCurrentState</span> animations:animations completion:completion];</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"><span class="meta">#endif</span></div><div class="line">    [<span class="built_in">UIView</span> animateWithDuration:<span class="number">0.3</span> delay:<span class="number">0.</span> options:<span class="built_in">UIViewAnimationOptionBeginFromCurrentState</span> animations:animations completion:completion];</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><p>从代码可以看出，这里只是对指示器的父视图做了放大缩小的动画。</p><h6 id="隐藏HUD"><a href="#隐藏HUD" class="headerlink" title="隐藏HUD"></a>隐藏HUD</h6><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">+ (<span class="built_in">BOOL</span>)hideHUDForView:(<span class="built_in">UIView</span> *)view animated:(<span class="built_in">BOOL</span>)animated &#123;</div><div class="line">    <span class="comment">//获取当前显示的hud,如果存在，当前隐藏时，将其从父视图移除</span></div><div class="line">    MBProgressHUD *hud = [<span class="keyword">self</span> HUDForView:view];</div><div class="line">    <span class="keyword">if</span> (hud != <span class="literal">nil</span>) &#123;</div><div class="line">        hud.removeFromSuperViewOnHide = <span class="literal">YES</span>;</div><div class="line">        [hud hideAnimated:animated];</div><div class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="literal">NO</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>在这个方法的执行过程中，调用<code>- (void)hideAnimated:(BOOL)animated</code>方法。<br></p><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"> - (<span class="keyword">void</span>)hideAnimated:(<span class="built_in">BOOL</span>)animated &#123;</div><div class="line">    MBMainThreadAssert();</div><div class="line">    [<span class="keyword">self</span>.graceTimer invalidate];</div><div class="line">    <span class="keyword">self</span>.useAnimation = animated;</div><div class="line">    <span class="keyword">self</span>.finished = <span class="literal">YES</span>;</div><div class="line">    <span class="comment">// 如果设置了最小显示时间，计算HUD显示时长，</span></div><div class="line">    <span class="comment">// 如果HUD显示时长小于最小显示时间，延迟显示</span></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.minShowTime &gt; <span class="number">0.0</span> &amp;&amp; <span class="keyword">self</span>.showStarted) &#123;</div><div class="line">        <span class="built_in">NSTimeInterval</span> interv = [[<span class="built_in">NSDate</span> date] timeIntervalSinceDate:<span class="keyword">self</span>.showStarted];</div><div class="line">        <span class="keyword">if</span> (interv &lt; <span class="keyword">self</span>.minShowTime) &#123;</div><div class="line">            <span class="built_in">NSTimer</span> *timer = [<span class="built_in">NSTimer</span> timerWithTimeInterval:(<span class="keyword">self</span>.minShowTime - interv) target:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(handleMinShowTimer:) userInfo:<span class="literal">nil</span> repeats:<span class="literal">NO</span>];</div><div class="line">            [[<span class="built_in">NSRunLoop</span> currentRunLoop] addTimer:timer forMode:<span class="built_in">NSRunLoopCommonModes</span>];</div><div class="line">            <span class="keyword">self</span>.minShowTimer = timer;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125; </div><div class="line">    &#125;</div><div class="line">    <span class="comment">// ... otherwise hide the HUD immediately</span></div><div class="line">    [<span class="keyword">self</span> hideUsingAnimation:<span class="keyword">self</span>.useAnimation];</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><p><code>- (void)hideAnimated:(BOOL)animated</code>方法中，主要做的是判断是否需要推迟隐藏HUD，最后调用<code>- (void)hideUsingAnimation:(BOOL)animated</code>方法，<br></p><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">- (<span class="keyword">void</span>)hideUsingAnimation:(<span class="built_in">BOOL</span>)animated &#123;</div><div class="line">    <span class="comment">//判断是否需要动画效果，如无，则直接隐藏</span></div><div class="line">    <span class="keyword">if</span> (animated &amp;&amp; <span class="keyword">self</span>.showStarted) &#123;</div><div class="line">        <span class="keyword">self</span>.showStarted = <span class="literal">nil</span>;</div><div class="line">        <span class="comment">//跟显示HUD差不多，只是指示器父视图没有做放大缩小的动画</span></div><div class="line">        [<span class="keyword">self</span> animateIn:<span class="literal">NO</span> withType:<span class="keyword">self</span>.animationType completion:^(<span class="built_in">BOOL</span> finished) &#123;</div><div class="line">            [<span class="keyword">self</span> done];</div><div class="line">        &#125;];</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">self</span>.showStarted = <span class="literal">nil</span>;</div><div class="line">        <span class="keyword">self</span>.bezelView.alpha = <span class="number">0.</span>f;</div><div class="line">        <span class="keyword">self</span>.backgroundView.alpha = <span class="number">1.</span>f;</div><div class="line">        [<span class="keyword">self</span> done];</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><p>最后，调用<code>- (void)done</code>方法。这个方法主要负责属性的释放和隐藏完成回调的处理。</p><pre><code class="objc">- (<span class="keyword">void</span>)done {    <span class="comment">// Cancel any scheduled hideDelayed: calls</span>    [<span class="keyword">self</span>.hideDelayTimer invalidate];    <span class="comment">//指示进度的显示问题，后续还需再补充</span>    [<span class="keyword">self</span> setNSProgressDisplayLinkEnabled:<span class="literal">NO</span>];    <span class="keyword">if</span> (<span class="keyword">self</span>.hasFinished) {        <span class="keyword">self</span>.alpha = <span class="number">0.0</span>f;        <span class="keyword">if</span> (<span class="keyword">self</span>.removeFromSuperViewOnHide) {            [<span class="keyword">self</span> removeFromSuperview];        }    }    MBProgressHUDCompletionBlock completionBlock = <span class="keyword">self</span>.completionBlock;    <span class="keyword">if</span> (completionBlock) {        completionBlock();    }    <span class="keyword">id</span>&lt;MBProgressHUDDelegate&gt; delegate = <span class="keyword">self</span>.delegate;    <span class="keyword">if</span> ([delegate respondsToSelector:<span class="keyword">@selector</span>(hudWasHidden:)]) {        [delegate performSelector:<span class="keyword">@selector</span>(hudWasHidden:) withObject:<span class="keyword">self</span>];    }}</code></pre><h5 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h5><p>从代码来看，<code>MBProgressHUD</code>这个三方库有几个地方值借鉴：</p><ul><li><code>graceTime</code>和<code>minShowTime</code>，在开发的时候会出现显示HUD后，存在缓存或者网速较好时，HUD显示到HUD隐藏的时间较短，界面出现闪动的情况，这时，就可以通过设置<code>graceTime</code>和<code>minShowTime</code>来处理，达到更好的用户体验。 这个在封装弹窗控件时，可以参考。</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;在项目中经常会使用&lt;code&gt;MBProgressHUD&lt;/code&gt;来实现弹窗提醒，所有来分析下&lt;code&gt;MBProgressHUD&lt;/code&gt;这个三方库的代码。所分析的源码版本号为1.0.0。&lt;/p&gt;&lt;hr&gt;&lt;p&gt;这篇总结主要分三个部分来介绍分析这个框架：&lt;/p&gt;&lt;
      
    
    </summary>
    
      <category term="三方开源库" scheme="http://leverTsui.github.io/categories/%E4%B8%89%E6%96%B9%E5%BC%80%E6%BA%90%E5%BA%93/"/>
    
    
      <category term="源码分析" scheme="http://leverTsui.github.io/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    
  </entry>
  
  <entry>
    <title>iOS布局与Masnory使用实践</title>
    <link href="http://leverTsui.github.io/2017/11/06/iOS%E5%B8%83%E5%B1%80%E4%B8%8EMasnory%E4%BD%BF%E7%94%A8%E5%AE%9E%E8%B7%B5/"/>
    <id>http://leverTsui.github.io/2017/11/06/iOS布局与Masnory使用实践/</id>
    <published>2017-11-06T10:46:28.000Z</published>
    <updated>2018-06-27T02:50:21.730Z</updated>
    
    <content type="html"><![CDATA[<h5 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h5><p><code>UI</code>布局对于<code>iOS</code>开发者来说并不陌生，在<code>iOS6</code>之前，大家都是通过<code>UI</code>控件的<code>Frame</code>属性和<code>Autoresizing Mask</code>来进行<code>UI</code>布局的（简称为手动布局）。<code>AutoLayout</code>则是苹果公司在<code>iOS6</code>推出的一种基于约束的，描述性的布局系统（简称为自动布局），这里主要从四个方面来阐述iOS布局及实践。</p><ul><li>手动布局和自动布局</li><li><code>AutoLayout</code>原理</li><li><code>AutoLayout</code>的性能</li><li><code>Masnory</code>的使用</li></ul><p>首先对手动布局和自动布局做一个简单的介绍：</p><h5 id="手动布局和自动布局"><a href="#手动布局和自动布局" class="headerlink" title="手动布局和自动布局"></a>手动布局和自动布局</h5><ul><li><p>手动布局：指的是通过直接修改视图的<code>frame</code>属性的方式对界面进行布局。</p><blockquote><p>对于<code>IOS</code>的<code>app</code>开发者来说，不会像<code>Android</code>开发者一样为很多的屏幕尺寸来做界面适配，因此手动调整 <code>frame</code>的方式来布局也能工作良好。但是还是会有一些问题，如设备发生旋转、适配<code>ipad</code>等，并且保证视图原来之间的相对关系，则以上的方法都是无法解决的。如果要做这些适配，在<code>AutoLayout</code>未出来之前需要编写大量的代码，并且花费大量的调试适配时间。</p></blockquote></li><li><p>自动布局：指的是使用<code>AutoLayout</code>的方式对界面进行布局。</p></li></ul><blockquote><p><code>AutoLayout</code> 是苹果本身提倡的技术，在大部分情况下也能很好的提升开发效率，但是 <code>AutoLayout</code>对于复杂视图来说常常会产生严重的性能问题。随着视图数量的增长，<code>AutoLayout</code> 带来的 <code>CPU</code> 消耗会呈指数级上升。 如果对界面流畅度要求较高（如微博界面），可以通过提前计算好布局，在需要时一次性调整好对应属性 ，或者使用 <code>ComponentKit</code>、<code>AsyncDisplayKit</code> 等框架来处理界面布局。</p></blockquote><p>下面，我们来分析下 AutoLayout的原理。</p><h5 id="AutoLayout的原理"><a href="#AutoLayout的原理" class="headerlink" title="AutoLayout的原理"></a>AutoLayout的原理</h5><p>这里通过使用<code>Masonry</code>来进行布局，从而来分析<code>AutoLayout</code>的原理，先简要了解下<code>Masonry</code>。<br><code>Masonry</code>是一个轻量级的布局框架，拥有自己的描述语法，采用更优雅的链式语法封装自动布局，简洁明了，并具有高可读性，而且同时支持 <code>iOS</code> 和 <code>Max OS X</code>。<br><code>Masnory</code>支持的常用属性如下：<br></p><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *left;     <span class="comment">//左侧</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *top;      <span class="comment">//上侧</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *right;   <span class="comment">//右侧</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *bottom;   <span class="comment">//下侧</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *leading;  <span class="comment">//首部</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *trailing;  <span class="comment">//首部</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *width;    <span class="comment">//宽</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *height;   <span class="comment">//高</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *centerX;  <span class="comment">//横向中点</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *centerY;  <span class="comment">//纵向中点</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *baseline; <span class="comment">//文本基线</span></div></pre></td></tr></table></figure><p></p><p><strong>其中<code>leading</code>与<code>left</code>，<code>trailing</code>与<code>right</code> 在正常情况下是等价的，但是当一些布局是从右至左时(比如阿拉伯语) 则会对调。</strong><br>同时，在<code>Masonry</code>中能够添加<code>AutoLayout</code>约束有三个函数：<br></p><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">- (<span class="built_in">NSArray</span> *)mas_makeConstraints:(<span class="keyword">void</span>(^)(MASConstraintMaker *make))block;<span class="comment">//只负责新增约束` AutoLayout`不能同时存在两条针对于同一对象的约束,否则会报错</span></div><div class="line">- (<span class="built_in">NSArray</span> *)mas_updateConstraints:(<span class="keyword">void</span>(^)(MASConstraintMaker *make))block;<span class="comment">//针对上面的情况 会更新在block中出现的约束 不会导致出现两个相同约束的情况</span></div><div class="line">- (<span class="built_in">NSArray</span> *)mas_remakeConstraints:(<span class="keyword">void</span>(^)(MASConstraintMaker *make))block;<span class="comment">//则会清除之前的所有约束 仅保留最新的约束</span></div></pre></td></tr></table></figure><p></p><p>我们在代码中，经常会使用到<code>equalTo</code>和<code>mas_equalTo</code>，那它们的区别是什么呢？从代码中找到他们的定义如下：<br></p><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#define mas_equalTo(...)                 equalTo(MASBoxValue((__VA_ARGS__)))</span></div><div class="line">...</div><div class="line"><span class="meta">#define MASBoxValue(value) _MASBoxValue(@encode(__typeof__((value))), (value))</span></div></pre></td></tr></table></figure><p></p><p>可以看到 <code>mas_equalTo</code>只是对其参数进行了一个<code>BOX</code>操作(装箱) ，所支持的类型，除了<code>NSNumber</code>支持的那些数值类型之外，还支持<code>CGPoint</code>，<code>CGSize</code>和<code>UIEdgeInsets</code>类型。<br>下面，我们通过一个例子，一步步来看下界面是怎么布局的，代码如下：<br></p><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    <span class="keyword">self</span>.view.backgroundColor = [<span class="built_in">UIColor</span> blackColor];</div><div class="line">    </div><div class="line">    <span class="built_in">UIView</span> *v1 = [[<span class="built_in">UIView</span> alloc] init];</div><div class="line">    v1.backgroundColor = [<span class="built_in">UIColor</span> orangeColor];</div><div class="line">    [v1 showPlaceHolder];</div><div class="line">    </div><div class="line">    <span class="built_in">UIView</span> *v2 = [[<span class="built_in">UIView</span> alloc] init];</div><div class="line">    v2.backgroundColor = [<span class="built_in">UIColor</span> orangeColor];</div><div class="line">    [v2 showPlaceHolder];</div><div class="line">    </div><div class="line">    <span class="built_in">UIView</span> *v3 = [[<span class="built_in">UIView</span> alloc] init];</div><div class="line">    v3.backgroundColor = [<span class="built_in">UIColor</span> orangeColor];</div><div class="line">    [v3 showPlaceHolder];</div><div class="line">    </div><div class="line">    [<span class="keyword">self</span>.view addSubview:v1];</div><div class="line">    [<span class="keyword">self</span>.view addSubview:v2];</div><div class="line">    [<span class="keyword">self</span>.view addSubview:v3];</div><div class="line">    </div><div class="line">    [v1 mas_makeConstraints:^(MASConstraintMaker *make) &#123;</div><div class="line">        make.top.mas_equalTo(<span class="number">100</span>);</div><div class="line">        make.leading.mas_equalTo(<span class="number">100</span>);</div><div class="line">        make.width.mas_equalTo(<span class="number">70</span>);</div><div class="line">        make.height.mas_equalTo(<span class="number">65</span>);</div><div class="line">    &#125;];</div><div class="line">    </div><div class="line">    [v2 mas_makeConstraints:^(MASConstraintMaker *make) &#123;</div><div class="line">        make.top.equalTo(v1.mas_top);</div><div class="line">        make.leading.mas_equalTo(v1.mas_trailing).offset(<span class="number">20</span>);</div><div class="line">        make.width.equalTo(v1.mas_width);</div><div class="line">        make.height.equalTo(v1.mas_height);</div><div class="line">    &#125;];</div><div class="line">    </div><div class="line">    [v3 mas_makeConstraints:^(MASConstraintMaker *make) &#123;</div><div class="line">        make.top.equalTo(v1.mas_bottom).offset(<span class="number">20</span>);</div><div class="line">        make.leading.equalTo(v1.mas_leading);</div><div class="line">        make.trailing.equalTo(v2.mas_trailing);</div><div class="line">        make.height.equalTo(v1.mas_height);</div><div class="line">    &#125;];</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><p>界面运行结果如下图：<br><img src="http://upload-images.jianshu.io/upload_images/5835116-10acd4fa0c0e292c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="CD52E302-FAFD-4D6E-9DFF-F5DB44C6098B.png"><br>下面，我们将界面中的左上角的视图视为视图1，右上角的视图视为视图2，底部视图视为视图3，使用<code>x1、y1、m1、n1</code>来标识视图1的<code>left</code>、<code>top</code>、<code>width</code>和<code>height</code>，以此类推。<br>通过以上举例抽象出自动布局数学公式：<br><img src="http://upload-images.jianshu.io/upload_images/5835116-6ceec51e08a7f571.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="1C7344E7-1ED1-421A-B84E-ACBD70F98859.png"><br>将以上等式变形为：</p><p><img src="http://upload-images.jianshu.io/upload_images/5835116-101854d5027207fd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="8AAD54BE-0157-4591-A117-0094F69BE6E7.png"><br>此时，以上方程组，大家肯定很熟悉了，也就是《线性代数》中的线性方程组，现在将以上线性方程组抽象为：</p><p><img src="http://upload-images.jianshu.io/upload_images/5835116-665ec9939aa6a902.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="B5E84F57-07DE-4A15-9D06-3D0ADD7E6EBD.png"><br>上图表示“等式”方程组，那么是否还可以继续抽象？也就是说上述方程组能否完全表示未知元素之间与已知元素之间的关系，显然还不全面，因为还有（&lt;,&gt;,&lt;=,&gt;=）不等关系，因此将“=”等号抽象为关系”R”,在数学上关系R也就包括了“=”,”&lt;”,”&gt;”,”&lt;=”,”&gt;=”等关系。上述线程方程组变形为：（实质上，AutoLayout中所有的约束确实都是用数学关系式y R ax + b描述）</p><p><img src="http://upload-images.jianshu.io/upload_images/5835116-8ae25f0ead6f4c29.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="9A877277-5DEB-437C-AEF6-D6530AB6FE6F.png"><br>现在已经将自动布局一步步抽象为数学公式，那么对视图的布局其实就是对线性方程组的求解。线性方程组解的情况有三种，实质上也对应着自动布局对视图的三种布局方案:</p><ul><li>唯一解：所有方程中的未知数能够解出唯一解。 充分约束：给一个视图添加的约束必须是充分的，才能正确布局一个视图；</li><li>多个解：未知数不能求解出准确的唯一解，即未知数可能存在多个或者无限个解满足线性方程组。 欠约束：给视图所添加的约束不能够充分的表达视图的准确位置，在这种情况下自动布局会随意给视图一个布局方案，也就是自动布局中视图不能够正确布局或者视图丢失的情况。</li><li>无解：不存在满足线性方程组的解。 冲突约束：给视图添加的约束表达视图布局出现了冲突，比如同时满足同一个视图宽度即为100又为200，这是不可能存在的。此时程序会出现崩溃。</li></ul><p>通过以上描述，将<code>AutoLayout</code>系统的作用描述如图所示：</p><p><img src="http://upload-images.jianshu.io/upload_images/5835116-55978c66c8eea66b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="FBB5F53F-0B23-48B2-B150-39B405BFB335.png"></p><h5 id="AutoLayout的性能"><a href="#AutoLayout的性能" class="headerlink" title="AutoLayout的性能"></a><code>AutoLayout</code>的性能</h5><p>从<code>AutoLayout</code>的原理，我们可以得出布局系统最后仍然需要通过<code>frame</code>来进行布局，相比原有的布局系统加入了从约束计算 出<code>frame</code> 的过程,那么这个过程对性能是否会影响呢？<br>你可以在 <a href="https://github.com/leverTsui/summary" target="_blank" rel="external"><strong>这里</strong></a> 找到这次对 <code>Layout</code> 性能测量使用的代码。<br>代码分别使用<code>Auto Layout</code>、嵌套视图层级中使用 <code>Auto Layout</code>和<code>frame</code>对 <code>N</code> 个视图进行布局，测算其运行时间。</p><p>对视图数量在 1~35 之间布局时间进行测量，结果如下：</p><p><img src="http://upload-images.jianshu.io/upload_images/117999-045780ced38306d5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="视图数量范围为 1~35.png"></p><p>对视图数量在 10~500 之间布局时间进行测量，结果如下：</p><p><img src="http://upload-images.jianshu.io/upload_images/117999-4a5f70dd55e894d8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="视图数量范围为 10~500.png"><br>从上述的测试数据可以看出，<strong>使用<code>frame</code>、<code>AutoLayout</code>和嵌套视图层级中使用 <code>Auto Layout</code>进行布局、对应的视图数量分别为<code>50</code>个、<code>6</code>个和<code>12</code>个，所需要的时间就会在 <code>16.67 ms</code>左右。</strong>,而想要让 iOS 应用的视图保持 60 FPS 的刷新频率，我们必须在 1/60 = 16.67 ms 之内完成包括布局、绘制以及渲染等操作。<br>综上所述，虽然说 <code>Auto Layout</code> 为开发者在多尺寸布局上提供了遍历，而且支持跨越视图层级的约束，但是由于其实现原理导致其时间复杂度为<strong>多项式时间</strong>，其性能损耗是仅使用 <code>frame</code> 的十几倍，所以在处理庞大的 <code>UI</code>界面时表现差强人意。</p><h5 id="Masnory的使用"><a href="#Masnory的使用" class="headerlink" title="Masnory的使用"></a><code>Masnory</code>的使用</h5><p>下面，我们通过4个实例，来了解下<code>Masnory</code>的使用。</p><ul><li>######case 1: 并排显示两个<code>label</code>，宽度由内容决定。父视图宽度不够时，优先显示右边<code>label</code>的内容。</li></ul><p>在默认情况下，我们没有设置各个布局的优先级，那么他就会优先显示左边的<code>label</code>，左边的完全显示后剩余的空间都是右边的<code>label</code>，如果整个空间宽度都不够左边的<code>label</code>的话，那么右边的<code>label</code>就没有显示的机会了。<br>如果我们现在的需求是优先显示右边的<code>label</code>，左边的<code>label</code>内容超出的省略，这时就需要我们调整约束的优先级了。<br><code>UIView</code>中关于<code>Content Hugging</code> 和<code>Content Compression Resistance</code>的方法有：<br></p><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">- (<span class="built_in">UILayoutPriority</span>)contentHuggingPriorityForAxis:(<span class="built_in">UILayoutConstraintAxis</span>)axis <span class="built_in">NS_AVAILABLE_IOS</span>(<span class="number">6</span>_0);</div><div class="line">- (<span class="keyword">void</span>)setContentHuggingPriority:(<span class="built_in">UILayoutPriority</span>)priority forAxis:(<span class="built_in">UILayoutConstraintAxis</span>)axis <span class="built_in">NS_AVAILABLE_IOS</span>(<span class="number">6</span>_0);</div><div class="line"></div><div class="line">- (<span class="built_in">UILayoutPriority</span>)contentCompressionResistancePriorityForAxis:(<span class="built_in">UILayoutConstraintAxis</span>)axis <span class="built_in">NS_AVAILABLE_IOS</span>(<span class="number">6</span>_0);</div><div class="line">- (<span class="keyword">void</span>)setContentCompressionResistancePriority:(<span class="built_in">UILayoutPriority</span>)priority forAxis:(<span class="built_in">UILayoutConstraintAxis</span>)axis <span class="built_in">NS_AVAILABLE_IOS</span>(<span class="number">6</span>_0);</div></pre></td></tr></table></figure><p></p><p>那么这两个东西到底是什么呢？可以这样形象的理解一下：</p><ul><li><code>contentHugging</code>: 抱住使其在“内容大小”的基础上不能继续变大，这个属性的优先级越高，就要越“抱紧”视图里面的内容。也就是视图的大小不会随着父视图的扩大而扩大。</li><li><code>contentCompression</code>: 撑住使其在在其“内容大小”的基础上不能继续变小,这个属性的优先级越高，越不“容易”被压缩。也就是说，当整体的空间装不下所有的视图时，<code>Content Compression Resistance</code>优先级越高的，显示的内容越完整。<br>这两个属性分别可以设置水平方向和垂直方向上的，而且一个默认优先级是250， 一个默认优先级是750. 因为这两个很有可能与其他Constraint冲突，所以优先级较低。</li></ul><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="built_in">UILayoutPriority</span> <span class="built_in">UILayoutPriorityRequired</span> <span class="built_in">NS_AVAILABLE_IOS</span>(<span class="number">6</span>_0) = <span class="number">1000</span>; <span class="comment">// A required constraint.  Do not exceed this.</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="built_in">UILayoutPriority</span> <span class="built_in">UILayoutPriorityDefaultHigh</span> <span class="built_in">NS_AVAILABLE_IOS</span>(<span class="number">6</span>_0) = <span class="number">750</span>; <span class="comment">// This is the priority level with which a button resists compressing its content.</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="built_in">UILayoutPriority</span> <span class="built_in">UILayoutPriorityDefaultLow</span> <span class="built_in">NS_AVAILABLE_IOS</span>(<span class="number">6</span>_0) = <span class="number">250</span>; <span class="comment">// This is the priority level at which a button hugs its contents horizontally.</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="built_in">UILayoutPriority</span> <span class="built_in">UILayoutPriorityFittingSizeLevel</span> <span class="built_in">NS_AVAILABLE_IOS</span>(<span class="number">6</span>_0) = <span class="number">50</span>;</div></pre></td></tr></table></figure><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)layoutPageSubViews &#123;</div><div class="line">    </div><div class="line">    [<span class="keyword">self</span>.leftLabel mas_makeConstraints:^(MASConstraintMaker *make) &#123;</div><div class="line">        make.top.equalTo(<span class="keyword">self</span>.contentView1.mas_top).with.offset(<span class="number">5</span>);</div><div class="line">        make.left.equalTo(<span class="keyword">self</span>.contentView1.mas_left).with.offset(<span class="number">2</span>);</div><div class="line">        make.height.equalTo(@<span class="number">40</span>);</div><div class="line">    &#125;];</div><div class="line">    </div><div class="line">    [<span class="keyword">self</span>.rightLabel mas_makeConstraints:^(MASConstraintMaker *make) &#123;</div><div class="line">        make.left.equalTo(<span class="keyword">self</span>.leftLabel.mas_right).with.offset(<span class="number">2</span>);</div><div class="line">        make.top.equalTo(<span class="keyword">self</span>.contentView1.mas_top).with.offset(<span class="number">5</span>);</div><div class="line">        make.right.lessThanOrEqualTo(<span class="keyword">self</span>.contentView1.mas_right).with.offset(<span class="number">-2</span>);</div><div class="line">        make.height.equalTo(@<span class="number">40</span>);</div><div class="line"></div><div class="line">    &#125;];</div><div class="line">    </div><div class="line">    [<span class="keyword">self</span>.leftLabel setContentHuggingPriority:<span class="built_in">UILayoutPriorityRequired</span></div><div class="line">                               forAxis:<span class="built_in">UILayoutConstraintAxisHorizontal</span>];</div><div class="line">    [<span class="keyword">self</span>.leftLabel setContentCompressionResistancePriority:<span class="built_in">UILayoutPriorityDefaultLow</span></div><div class="line">                                             forAxis:<span class="built_in">UILayoutConstraintAxisHorizontal</span>];</div><div class="line">    </div><div class="line">    [<span class="keyword">self</span>.rightLabel setContentHuggingPriority:<span class="built_in">UILayoutPriorityRequired</span></div><div class="line">                               forAxis:<span class="built_in">UILayoutConstraintAxisHorizontal</span>];</div><div class="line">    [<span class="keyword">self</span>.rightLabel setContentCompressionResistancePriority:<span class="built_in">UILayoutPriorityRequired</span></div><div class="line">                                             forAxis:<span class="built_in">UILayoutConstraintAxisHorizontal</span>];</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>######case 2: 四个<code>ImageView</code>整体居中，可以任意显示、隐藏。</li></ul><p><img src="http://upload-images.jianshu.io/upload_images/5835116-1334685bb89094f9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="blog_autolayout_example_with_masonry_3.png"></p><p>下面的四个<code>Switch</code>控件分别控制上面对应位置的图片是否显示。</p><blockquote><p>分析:首先就是整体居中，为了实现这个，最简单的办法就是将四个图片“装进”一个<strong>容器View</strong>里面，然后让这个容器<code>View</code>在整个页面中居中即可。这样就不用控制每个图片的居中效果了。<br>然后就是显示与隐藏。在这里我直接控制图片<code>ImageView</code>的宽度，宽度为0的时候不就“隐藏”了吗。</p></blockquote><p>具体代码如下：</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)layoutPageSubViews &#123;</div><div class="line">    </div><div class="line">    [<span class="keyword">self</span>.containerView mas_makeConstraints:^(MASConstraintMaker *make) &#123;</div><div class="line">        make.height.mas_equalTo(IMAGE_SIZE);</div><div class="line">        make.centerX.equalTo(<span class="keyword">self</span>.view.mas_centerX);</div><div class="line">        make.top.equalTo(<span class="keyword">self</span>.view.mas_top).offset(<span class="number">200</span>);</div><div class="line">    &#125;];</div><div class="line">    </div><div class="line">    <span class="comment">//分别设置每个imageView的宽高、左边、垂直中心约束，注意约束的对象</span></div><div class="line">    <span class="comment">//每个View的左边约束和左边的View的右边相等</span></div><div class="line">    __block <span class="built_in">UIView</span> *lastView = <span class="literal">nil</span>;</div><div class="line">    __block MASConstraint *widthConstraint = <span class="literal">nil</span>;</div><div class="line">    <span class="built_in">NSUInteger</span> arrayCount = <span class="keyword">self</span>.imageViews.count;</div><div class="line">    [<span class="keyword">self</span>.imageViews enumerateObjectsUsingBlock:^(<span class="built_in">UIView</span> *view, <span class="built_in">NSUInteger</span> idx, <span class="built_in">BOOL</span> *stop) &#123;</div><div class="line">        [view mas_makeConstraints:^(MASConstraintMaker *make) &#123;</div><div class="line">            make.left.equalTo(lastView ? lastView.mas_right : view.superview.mas_left);</div><div class="line">            make.centerY.equalTo(view.superview.mas_centerY);</div><div class="line">            <span class="keyword">if</span> (idx == arrayCount - <span class="number">1</span>) &#123;</div><div class="line">                make.right.equalTo(view.superview.mas_right);</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            widthConstraint = make.width.mas_equalTo(IMAGE_SIZE);</div><div class="line">            make.height.mas_equalTo(IMAGE_SIZE);</div><div class="line">            </div><div class="line">            [<span class="keyword">self</span>.widthConstraints addObject:widthConstraint];</div><div class="line">            lastView = view;</div><div class="line">        &#125;];</div><div class="line">    &#125;];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">#pragma mark - event response</span></div><div class="line"><span class="comment">//点击switch按钮，如果打开，对应视图的宽约束设置为32，否则，设置为0</span></div><div class="line">- (<span class="keyword">IBAction</span>)showOrHideImage:(<span class="built_in">UISwitch</span> *)sender &#123;</div><div class="line">    <span class="built_in">NSUInteger</span> index = (<span class="built_in">NSUInteger</span>) sender.tag;</div><div class="line">    MASConstraint *width = <span class="keyword">self</span>.widthConstraints[index];</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (sender.on) &#123;</div><div class="line">        width.mas_equalTo(IMAGE_SIZE);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        width.mas_equalTo(<span class="number">0</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><p>#####case 3: 子视图的宽度始终是父视图的四分之三（或者任意百分比）</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">  <span class="comment">//宽度为父view的宽度的四分之三 </span></div><div class="line">[subView mas_makeConstraints:^(MASConstraintMaker *make) &#123;</div><div class="line">        <span class="comment">//上下左贴边</span></div><div class="line">        make.left.equalTo(_containerView.mas_left);</div><div class="line">        make.top.equalTo(_containerView.mas_top);</div><div class="line">        make.bottom.equalTo(_containerView.mas_bottom);</div><div class="line">        <span class="comment">//宽度为父view的宽度的一半</span></div><div class="line">        make.width.equalTo(_containerView.mas_width).multipliedBy(<span class="number">0.75</span>);</div><div class="line">    &#125;];</div></pre></td></tr></table></figure></li><li><p>#####case 4 给同一个属性添加多重约束，实现复杂关系</p></li></ul><pre><code class="objc">- (<span class="keyword">void</span>)layoutPageSubviews {    [<span class="keyword">self</span>.greenLabel mas_makeConstraints:^(MASConstraintMaker *make) {        make.centerY.equalTo(<span class="keyword">self</span>.containerView);        make.right.lessThanOrEqualTo(<span class="keyword">self</span>.containerView);        make.left.greaterThanOrEqualTo(<span class="keyword">self</span>.containerView.mas_right).multipliedBy((<span class="built_in">CGFloat</span>)(<span class="number">1.0</span>f / <span class="number">3.0</span>f));        <span class="keyword">for</span> (<span class="built_in">UILabel</span> *label <span class="keyword">in</span> <span class="keyword">self</span>.leftLabels) {            make.left.greaterThanOrEqualTo(label.mas_right).offset(<span class="number">8</span>);        }    }];    [<span class="keyword">self</span>.greenLabel setContentCompressionResistancePriority:<span class="built_in">UILayoutPriorityRequired</span> forAxis:<span class="built_in">UILayoutConstraintAxisHorizontal</span>];}</code></pre><h5 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h5><p>通过上述分析，我们可以发现：</p><ul><li><code>AutoLayout</code>的原理就是对线性方程组或者不等式的求解，最终使用<code>frame</code>来绘制视图；</li><li>使用<code>AutoLayout</code>进行布局时， 由于其实现原理导致其时间复杂度为多项式时间，其性能损耗是仅使用 frame 的十几倍，所以在处理庞大的 UI界面时表现差强人意。</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h5 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h5&gt;&lt;p&gt;&lt;code&gt;UI&lt;/code&gt;布局对于&lt;code&gt;iOS&lt;/code&gt;开发者来说并不陌生，在&lt;code&gt;iOS6&lt;/code&gt;之前，大家都是
      
    
    </summary>
    
      <category term="iOS 自动布局" scheme="http://leverTsui.github.io/categories/iOS-%E8%87%AA%E5%8A%A8%E5%B8%83%E5%B1%80/"/>
    
    
      <category term="自动布局 AutoLayout Masnory" scheme="http://leverTsui.github.io/tags/%E8%87%AA%E5%8A%A8%E5%B8%83%E5%B1%80-AutoLayout-Masnory/"/>
    
  </entry>
  
  <entry>
    <title>iOS二维码识别/二维码生成</title>
    <link href="http://leverTsui.github.io/2017/11/03/qr-droid/"/>
    <id>http://leverTsui.github.io/2017/11/03/qr-droid/</id>
    <published>2017-11-03T12:42:00.000Z</published>
    <updated>2018-06-27T06:03:43.248Z</updated>
    
    <content type="html"><![CDATA[<h4 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h4><p>之前做过一个关于二维码的组件，已发布，现总结下。<br>开发的<code>APP</code>所需支持的最低版本为<code>8.0</code>，最初的方案为扫描使用苹果自带的<code>API</code>实现扫一扫的功能、使用<code>ZXing</code>识别从相册或别人转发的二维码图片。但发现<code>ZXing</code>识别从相册中来的图片性能很差，很多图片识别不了，且耗时较长，遂使用<code>ZBar</code>来实现识别从相册或别人转发的二维码图片。<br>这个组件重要实现了三个功能，扫一扫识别二维码图片、长按图片识别二维码图片和生成二维码图片。<br>首先来看下扫一扫识别二维码图片的代码实现：</p><h4 id="功能实现"><a href="#功能实现" class="headerlink" title="功能实现"></a>功能实现</h4><h5 id="扫一扫识别二维码图片"><a href="#扫一扫识别二维码图片" class="headerlink" title="扫一扫识别二维码图片"></a>扫一扫识别二维码图片</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)initCapture &#123;</div><div class="line">    <span class="built_in">AVCaptureDevice</span>* inputDevice =</div><div class="line">    [<span class="built_in">AVCaptureDevice</span> defaultDeviceWithMediaType:<span class="built_in">AVMediaTypeVideo</span>]; </div><div class="line">    [inputDevice lockForConfiguration:<span class="literal">nil</span>];</div><div class="line">    <span class="keyword">if</span> ([inputDevice hasTorch])&#123;</div><div class="line">        inputDevice.torchMode = <span class="built_in">AVCaptureTorchModeAuto</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">AVCaptureFocusMode</span> foucusMode = <span class="built_in">AVCaptureFocusModeContinuousAutoFocus</span>;</div><div class="line">    <span class="keyword">if</span> ([inputDevice isFocusModeSupported:foucusMode]) &#123;</div><div class="line">        inputDevice.focusMode = foucusMode;</div><div class="line">    &#125;</div><div class="line">    [inputDevice unlockForConfiguration];</div><div class="line">    </div><div class="line">    <span class="built_in">AVCaptureDeviceInput</span> *captureInput =</div><div class="line">    [<span class="built_in">AVCaptureDeviceInput</span> deviceInputWithDevice:inputDevice error:<span class="literal">nil</span>];</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (!captureInput) &#123;</div><div class="line">        <span class="comment">//支持的最低版本为iOS8</span></div><div class="line">        <span class="built_in">UIAlertController</span> *alterVC = [<span class="built_in">UIAlertController</span> alertControllerWithTitle:MUIQRCodeLocalizedString(<span class="string">@"ScanViewController_system_tip"</span>) message:MUIQRCodeLocalizedString(<span class="string">@"ScanViewController_camera_permission"</span>) preferredStyle:<span class="built_in">UIAlertControllerStyleAlert</span>];</div><div class="line">        <span class="built_in">UIAlertAction</span> *confirmAction = [<span class="built_in">UIAlertAction</span> actionWithTitle:MUIQRCodeLocalizedString(<span class="string">@"ScanViewController_yes"</span>) style:<span class="built_in">UIAlertActionStyleDefault</span> handler:<span class="literal">nil</span>];</div><div class="line">        [alterVC addAction:confirmAction];</div><div class="line">        [<span class="keyword">self</span> presentViewController:alterVC animated:<span class="literal">YES</span> completion:<span class="literal">nil</span>];</div><div class="line">        [<span class="keyword">self</span>.activityView stopAnimating];</div><div class="line">        [<span class="keyword">self</span> onVideoStart:<span class="literal">nil</span>];</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="built_in">AVCaptureMetadataOutput</span> *captureOutput = [[<span class="built_in">AVCaptureMetadataOutput</span> alloc] init];</div><div class="line">    [captureOutput setMetadataObjectsDelegate:<span class="keyword">self</span> queue:_queue];</div><div class="line">    <span class="keyword">self</span>.captureOutput = captureOutput;</div><div class="line">    </div><div class="line">    <span class="keyword">self</span>.captureSession = [[<span class="built_in">AVCaptureSession</span> alloc] init];</div><div class="line">    [<span class="keyword">self</span>.captureSession addInput:captureInput];</div><div class="line">    [<span class="keyword">self</span>.captureSession addOutput:captureOutput];</div><div class="line">    </div><div class="line">    <span class="built_in">CGFloat</span> w = <span class="number">1920.</span>f;</div><div class="line">    <span class="built_in">CGFloat</span> h = <span class="number">1080.</span>f;</div><div class="line">    <span class="keyword">if</span> ([<span class="keyword">self</span>.captureSession canSetSessionPreset:<span class="built_in">AVCaptureSessionPreset1920x1080</span>]) &#123;</div><div class="line">        <span class="keyword">self</span>.captureSession.sessionPreset = <span class="built_in">AVCaptureSessionPreset1920x1080</span>;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([<span class="keyword">self</span>.captureSession canSetSessionPreset:<span class="built_in">AVCaptureSessionPreset1280x720</span>]) &#123;</div><div class="line">        <span class="keyword">self</span>.captureSession.sessionPreset = <span class="built_in">AVCaptureSessionPreset1280x720</span>;</div><div class="line">        w = <span class="number">1280.</span>f;</div><div class="line">        h = <span class="number">720.</span>f;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([<span class="keyword">self</span>.captureSession canSetSessionPreset:<span class="built_in">AVCaptureSessionPreset640x480</span>]) &#123;</div><div class="line">        <span class="keyword">self</span>.captureSession.sessionPreset = <span class="built_in">AVCaptureSessionPreset640x480</span>;</div><div class="line">        w = <span class="number">960.</span>f;</div><div class="line">        h = <span class="number">540.</span>f;</div><div class="line">    &#125;</div><div class="line">    captureOutput.metadataObjectTypes = [captureOutput availableMetadataObjectTypes];</div><div class="line">    <span class="built_in">CGRect</span> bounds = [[<span class="built_in">UIScreen</span> mainScreen] bounds];</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span>.prevLayer) &#123;</div><div class="line">        <span class="keyword">self</span>.prevLayer = [<span class="built_in">AVCaptureVideoPreviewLayer</span> layerWithSession:<span class="keyword">self</span>.captureSession];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">self</span>.prevLayer.frame = bounds;</div><div class="line">    <span class="keyword">self</span>.prevLayer.videoGravity = <span class="built_in">AVLayerVideoGravityResizeAspectFill</span>;</div><div class="line">    [<span class="keyword">self</span>.view.layer insertSublayer:<span class="keyword">self</span>.prevLayer atIndex:<span class="number">0</span>];</div><div class="line">    <span class="comment">//下面代码主要用来设置扫描的聚焦范围，计算rectOfInterest</span></div><div class="line">    <span class="built_in">CGFloat</span> p1 = bounds.size.height/bounds.size.width;</div><div class="line">    <span class="built_in">CGFloat</span> p2 = w/h;</div><div class="line">    </div><div class="line">    <span class="built_in">CGRect</span> cropRect = <span class="built_in">CGRectMake</span>(<span class="built_in">CGRectGetMinX</span>(_cropRect) - kSNReaderScanExpandWidth, <span class="built_in">CGRectGetMinY</span>(_cropRect) - kSNReaderScanExpandHeight, <span class="built_in">CGRectGetWidth</span>(_cropRect) + <span class="number">2</span>*kSNReaderScanExpandWidth, <span class="built_in">CGRectGetHeight</span>(_cropRect) + <span class="number">2</span>*kSNReaderScanExpandHeight);</div><div class="line">    </div><div class="line"><span class="comment">//    CGRect cropRect = _cropRect;</span></div><div class="line">    <span class="keyword">if</span> (fabs(p1 - p2) &lt; <span class="number">0.00001</span>) &#123;</div><div class="line">        captureOutput.rectOfInterest = <span class="built_in">CGRectMake</span>(cropRect.origin.y /bounds.size.height,                         cropRect.origin.x/bounds.size.width,</div><div class="line">                                                  cropRect.size.height/bounds.size.height,</div><div class="line">                                                  cropRect.size.width/bounds.size.width);</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (p1 &lt; p2) &#123;</div><div class="line">        <span class="comment">//实际图像被截取一段高</span></div><div class="line">        <span class="built_in">CGFloat</span> fixHeight = bounds.size.width * w / h;</div><div class="line">        <span class="built_in">CGFloat</span> fixPadding = (fixHeight - bounds.size.height)/<span class="number">2</span>;</div><div class="line">        captureOutput.rectOfInterest = <span class="built_in">CGRectMake</span>((cropRect.origin.y + fixPadding)/fixHeight,</div><div class="line">                                                  cropRect.origin.x/bounds.size.width,</div><div class="line">                                                  cropRect.size.height/fixHeight,</div><div class="line">                                                  cropRect.size.width/bounds.size.width);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="built_in">CGFloat</span> fixWidth = bounds.size.height * h / w;</div><div class="line">        <span class="built_in">CGFloat</span> fixPadding = (fixWidth - bounds.size.width)/<span class="number">2</span>;</div><div class="line">        captureOutput.rectOfInterest = <span class="built_in">CGRectMake</span>(cropRect.origin.y/bounds.size.height,</div><div class="line">                                                  (cropRect.origin.x + fixPadding)/fixWidth,</div><div class="line">                                                  cropRect.size.height/bounds.size.height,</div><div class="line">                                                  cropRect.size.width/fixWidth);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h5 id="识别二维码图片"><a href="#识别二维码图片" class="headerlink" title="识别二维码图片"></a>识别二维码图片</h5><p>识别二维码图片的功能，最初的方案是使用三方库<code>ZXing</code>来实现，因为<code>ZXing</code>有人在维护，但<code>ZXing</code>识别相册中的二维码图片或本地的图片时，有些图片根本就识别不出来，且耗时较长，所以改为使用<code>ZBar</code>。在网上找到一篇文章<a href="http://adad184.com/2015/09/30/goodbye-zxing/" target="_blank" rel="external">再见ZXing 使用系统原生代码处理QRCode</a>,实测发现使用系统原生代码来识别二维码图片时，在，iphone4s，系统为iOS9的手机发现传回来的数组为空。代码如下：<br></p><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">- (<span class="built_in">NSString</span> *)decodeQRImageWith:(<span class="built_in">UIImage</span>*)aImage &#123;</div><div class="line">    <span class="built_in">NSString</span> *qrResult = <span class="literal">nil</span>; </div><div class="line">    <span class="comment">//iOS8及以上可以使用系统自带的识别二维码图片接口，但此api有问题，在一些机型上detector为nil。 </span></div><div class="line">    <span class="keyword">if</span> (iOS8_OR_LATER) &#123; </div><div class="line">          <span class="built_in">CIContext</span> *context = [<span class="built_in">CIContext</span> contextWithOptions:<span class="literal">nil</span>];</div><div class="line">          <span class="built_in">CIDetector</span> *detector = [<span class="built_in">CIDetector</span> detectorOfType:<span class="built_in">CIDetectorTypeQRCode</span> context:context options:@&#123;<span class="built_in">CIDetectorAccuracy</span>:<span class="built_in">CIDetectorAccuracyHigh</span>&#125;];</div><div class="line">          <span class="built_in">CIImage</span> *image = [<span class="built_in">CIImage</span> imageWithCGImage:aImage.CGImage];</div><div class="line">          <span class="built_in">NSArray</span> *features = [detector featuresInImage:image];</div><div class="line">          <span class="built_in">CIQRCodeFeature</span> *feature = [features firstObject]; </div><div class="line">          qrResult = feature.messageString;</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">          ZBarReaderController* read = [ZBarReaderController new];</div><div class="line">          <span class="built_in">CGImageRef</span> cgImageRef = aImage.CGImage;</div><div class="line">          ZBarSymbol* symbol = <span class="literal">nil</span>;</div><div class="line">          <span class="keyword">for</span>(symbol <span class="keyword">in</span> [read scanImage:cgImageRef]) <span class="keyword">break</span>;</div><div class="line">             qrResult = symbol.data ;</div><div class="line">            <span class="keyword">return</span> qrResult;</div><div class="line">     &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure><p></p><p>无图无真相：</p><p><img src="http://upload-images.jianshu.io/upload_images/117999-5dae9fc15755140c.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="14567CBE-E1D2-4FA7-AFA3-8B2037171F38.jpg"></p><p>detector的值为nil，也就是说</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">CIDetector</span> *detector = [<span class="built_in">CIDetector</span> detectorOfType:<span class="built_in">CIDetectorTypeQRCode</span> context:context options:@&#123;<span class="built_in">CIDetectorAccuracy</span>:<span class="built_in">CIDetectorAccuracyHigh</span>&#125;];</div></pre></td></tr></table></figure><p>CIDetector的初始化方法无效。推测是苹果API的问题。</p><h5 id="生成二维码图片"><a href="#生成二维码图片" class="headerlink" title="生成二维码图片"></a>生成二维码图片</h5><p>在<code>iOS8</code>及以上版本使用苹果的<code>API</code>生成二维码图片，代码如下：<br></p><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">- (<span class="built_in">UIImage</span> *)encodeQRImageWithContent:(<span class="built_in">NSString</span> *)content size:(<span class="built_in">CGSize</span>)size &#123;</div><div class="line">    <span class="built_in">UIImage</span> *codeImage = <span class="literal">nil</span>;</div><div class="line">    <span class="keyword">if</span> (iOS8_OR_LATER) &#123;</div><div class="line">        <span class="built_in">NSData</span> *stringData = [content dataUsingEncoding: <span class="built_in">NSUTF8StringEncoding</span>]; </div><div class="line">        <span class="comment">//生成</span></div><div class="line">      <span class="built_in">CIFilter</span> *qrFilter = [<span class="built_in">CIFilter</span> filterWithName:<span class="string">@"CIQRCodeGenerator"</span>];</div><div class="line">      [qrFilter setValue:stringData forKey:<span class="string">@"inputMessage"</span>];</div><div class="line">      [qrFilter setValue:<span class="string">@"M"</span> forKey:<span class="string">@"inputCorrectionLevel"</span>];</div><div class="line">      <span class="built_in">UIColor</span> *onColor = [<span class="built_in">UIColor</span> blackColor];</div><div class="line">      <span class="built_in">UIColor</span> *offColor = [<span class="built_in">UIColor</span> whiteColor];</div><div class="line">      <span class="comment">//上色</span></div><div class="line">      <span class="built_in">CIFilter</span> *colorFilter = [<span class="built_in">CIFilter</span> filterWithName:<span class="string">@"CIFalseColor"</span></div><div class="line">                                         keysAndValues:</div><div class="line">                               <span class="string">@"inputImage"</span>,qrFilter.outputImage,</div><div class="line">                               <span class="string">@"inputColor0"</span>,[<span class="built_in">CIColor</span> colorWithCGColor:onColor.CGColor],</div><div class="line">                               <span class="string">@"inputColor1"</span>,[<span class="built_in">CIColor</span> colorWithCGColor:offColor.CGColor],</div><div class="line">                               <span class="literal">nil</span>];</div><div class="line"></div><div class="line">      <span class="built_in">CIImage</span> *qrImage = colorFilter.outputImage;</div><div class="line">      <span class="built_in">CGImageRef</span> cgImage = [[<span class="built_in">CIContext</span> contextWithOptions:<span class="literal">nil</span>] createCGImage:qrImage fromRect:qrImage.extent];</div><div class="line">      <span class="built_in">UIGraphicsBeginImageContext</span>(size);</div><div class="line">      <span class="built_in">CGContextRef</span> context = <span class="built_in">UIGraphicsGetCurrentContext</span>();</div><div class="line">      <span class="built_in">CGContextSetInterpolationQuality</span>(context, kCGInterpolationNone);</div><div class="line">      <span class="built_in">CGContextScaleCTM</span>(context, <span class="number">1.0</span>, <span class="number">-1.0</span>);</div><div class="line">      <span class="built_in">CGContextDrawImage</span>(context, <span class="built_in">CGContextGetClipBoundingBox</span>(context), cgImage);</div><div class="line">      codeImage = <span class="built_in">UIGraphicsGetImageFromCurrentImageContext</span>();</div><div class="line">      <span class="built_in">UIGraphicsEndImageContext</span>(); </div><div class="line">      <span class="built_in">CGImageRelease</span>(cgImage);</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">          codeImage = [QRCodeGenerator qrImageForString:content imageSize:size.width];</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> codeImage;</div><div class="line">  &#125;</div></pre></td></tr></table></figure><p></p><p><code>iOS8</code>以下使用<code>libqrencode</code>库来生成二维码图片。</p><h4 id="代码完善"><a href="#代码完善" class="headerlink" title="代码完善"></a>代码完善</h4><p><code>2015年12月11日</code></p><p><code>QA</code>测试发现，服务端生成的二维码，使用<code>ZBar</code>识别不出来，但将这张图片保存到相册，然后发送就可以识别出来。最初的想法是要服务端修改生成的二维码，但安卓能够识别出来，此路不通，那只有看ZBar的源码了。<br></p><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">id</span> &lt;<span class="built_in">NSFastEnumeration</span>&gt;) scanImage: (<span class="built_in">CGImageRef</span>) image &#123;</div><div class="line">        timer_start;</div><div class="line">        <span class="keyword">int</span> nsyms = [<span class="keyword">self</span> scanImage: image</div><div class="line">                          withScaling: <span class="number">0</span>];</div><div class="line">      <span class="comment">//没有识别出来，判断CGImageRef对象的宽和高是否大于640，大于或等于的话进行缩放再进行扫描</span></div><div class="line">        <span class="keyword">if</span>(!nsyms &amp;&amp;</div><div class="line">           <span class="built_in">CGImageGetWidth</span>(image) &gt;= <span class="number">640</span> &amp;&amp;</div><div class="line">           <span class="built_in">CGImageGetHeight</span>(image) &gt;= <span class="number">640</span>)</div><div class="line">            <span class="comment">// make one more attempt for close up, grainy images</span></div><div class="line">            nsyms = [<span class="keyword">self</span> scanImage: image</div><div class="line">                          withScaling: <span class="number">.5</span>];</div><div class="line"></div><div class="line">        <span class="built_in">NSMutableArray</span> *syms = <span class="literal">nil</span>;</div><div class="line">        <span class="keyword">if</span>(nsyms) &#123;</div><div class="line">            <span class="comment">// quality/type filtering</span></div><div class="line">            <span class="keyword">int</span> max_quality = MIN_QUALITY;</div><div class="line">            <span class="keyword">for</span>(ZBarSymbol *sym <span class="keyword">in</span> scanner.results) &#123;</div><div class="line">                zbar_symbol_type_t type = sym.type;</div><div class="line">                <span class="keyword">int</span> quality;</div><div class="line">                <span class="keyword">if</span>(type == ZBAR_QRCODE)</div><div class="line">                    quality = INT_MAX;</div><div class="line">                <span class="keyword">else</span></div><div class="line">                    quality = sym.quality;</div><div class="line"></div><div class="line">                <span class="keyword">if</span>(quality &lt; max_quality) &#123;</div><div class="line">                    zlog(<span class="string">@"    type=%d quality=%d &lt; %d\n"</span>,</div><div class="line">                         type, quality, max_quality);</div><div class="line">                    <span class="keyword">continue</span>;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">if</span>(max_quality &lt; quality) &#123;</div><div class="line">                    max_quality = quality;</div><div class="line">                    <span class="keyword">if</span>(syms)</div><div class="line">                        [syms removeAllObjects];</div><div class="line">                &#125;</div><div class="line">                zlog(<span class="string">@"    type=%d quality=%d\n"</span>, type, quality);</div><div class="line">                <span class="keyword">if</span>(!syms)</div><div class="line">                    syms = [<span class="built_in">NSMutableArray</span> arrayWithCapacity: <span class="number">1</span>];</div><div class="line"></div><div class="line">                [syms addObject: sym];</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        zlog(<span class="string">@"read %d filtered symbols in %gs total\n"</span>,</div><div class="line">              (!syms) ? <span class="number">0</span> : [syms count], timer_elapsed(t_start, timer_now()));</div><div class="line">        <span class="keyword">return</span>(syms);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span>(max_quality &lt; quality) &#123;</div><div class="line">          max_quality = quality;</div><div class="line">          <span class="keyword">if</span>(syms)</div><div class="line">              [syms removeAllObjects];</div><div class="line">      &#125;</div><div class="line">      zlog(<span class="string">@"    type=%d quality=%d\n"</span>, type, quality);</div><div class="line">      <span class="keyword">if</span>(!syms)</div><div class="line">          syms = [<span class="built_in">NSMutableArray</span> arrayWithCapacity: <span class="number">1</span>];</div><div class="line"></div><div class="line">      [syms addObject: sym];</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line">  zlog(<span class="string">@"read %d filtered symbols in %gs total\n"</span>,</div><div class="line">        (!syms) ? <span class="number">0</span> : [syms count], timer_elapsed(t_start, timer_now()));</div><div class="line">  <span class="keyword">return</span>(syms);</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><p>在这里就产生了一个解决有些二维码图片识别不出来的解决思路：将传过来的<code>UIImage</code>的宽和高设置为640，识别不出来再进行缩放识别。修改<code>UIImage</code>的代码如下：<br></p><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">-(<span class="built_in">UIImage</span> *)TransformtoSize:(<span class="built_in">CGSize</span>)Newsize &#123;</div><div class="line">    <span class="comment">// 创建一个bitmap的context</span></div><div class="line">    <span class="built_in">UIGraphicsBeginImageContext</span>(Newsize);</div><div class="line">    <span class="comment">// 绘制改变大小的图片</span></div><div class="line">    [<span class="keyword">self</span> drawInRect:<span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, Newsize.width, Newsize.height)];</div><div class="line">    <span class="comment">// 从当前context中创建一个改变大小后的图片</span></div><div class="line">    <span class="built_in">UIImage</span> *TransformedImg=<span class="built_in">UIGraphicsGetImageFromCurrentImageContext</span>();</div><div class="line">    <span class="comment">// 使当前的context出堆栈</span></div><div class="line">    <span class="built_in">UIGraphicsEndImageContext</span>();</div><div class="line">    <span class="comment">// 返回新的改变大小后的图片</span></div><div class="line">    <span class="keyword">return</span> TransformedImg;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><p>这样类似于将<code>ZXing</code>中的<code>tryHard</code>设置为<code>YES</code>。识别不出来的二维码图片就可以识别了。</p><p><code>2016年5月20日</code><br><code>遗留的bug</code>: 点击进入扫一扫界面，退出，再进入，这样重复5次左右，扫一扫之前的界面的会出现卡顿。<br>原因：多次进入扫一扫界面，再退出，因此界面未被系统回收，captureSession对象一直在运行，会造成内存泄露，引起上一个界面卡顿。<br>解决方案：在视图将要消失的时候，确保captureSession对象停止运行。<br></p><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)viewWillDisappear:(<span class="built_in">BOOL</span>)animated &#123;</div><div class="line">  [<span class="keyword">super</span> viewWillDisappear:animated];</div><div class="line">  <span class="keyword">if</span> ([<span class="keyword">self</span>.captureSession isRunning]) &#123;</div><div class="line">      [<span class="keyword">self</span>.captureSession stopRunning];</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><p><code>2018年4月28日</code><br>识别二维码图片优化</p><p>近期通过<code>bugly</code>收集卡顿问题发现，二维码组件在识别二维码图片时，会出现卡顿问题。为优化识别速度，采用了三种方案，并分别进行测试，并对测试数据进行分析，最终挑选出最优的方案。</p><blockquote><p>任务A：使用系统提供的CoreImage的CIDetector接口去识别二维码图片，返回对应的字符串；<br>任务B：使用zbar中的方法去识别二维码图片，返回对应的字符串。<br></p><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//任务A</span></div><div class="line">+ (<span class="built_in">NSString</span> *)useSystemMethodDecodeImage:(<span class="built_in">UIImage</span> *)image &#123;</div><div class="line">    <span class="built_in">NSString</span> *resultString = <span class="literal">nil</span>;</div><div class="line">    <span class="built_in">CIDetector</span> *detector = [<span class="built_in">CIDetector</span> detectorOfType:<span class="built_in">CIDetectorTypeQRCode</span></div><div class="line">                                              context:<span class="literal">nil</span></div><div class="line">                                              options:@&#123;<span class="built_in">CIDetectorAccuracy</span>:<span class="built_in">CIDetectorAccuracyHigh</span>&#125;];</div><div class="line">    <span class="keyword">if</span> (detector) &#123;</div><div class="line">        <span class="built_in">CIImage</span> *ciImage = [<span class="built_in">CIImage</span> imageWithCGImage:image.CGImage];</div><div class="line">        <span class="built_in">NSArray</span> *features = [detector featuresInImage:ciImage];</div><div class="line">        <span class="built_in">CIQRCodeFeature</span> *feature = [features firstObject];</div><div class="line">        resultString = feature.messageString;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> resultString;</div><div class="line">&#125;</div><div class="line"><span class="comment">//任务B</span></div><div class="line">+ (<span class="built_in">NSString</span> *)useZbarMethodDecodeImage:(<span class="built_in">UIImage</span> *)image &#123;</div><div class="line">    <span class="built_in">UIImage</span> *decodeImage = image;</div><div class="line">    <span class="keyword">if</span> (decodeImage.size.width &lt; <span class="number">641</span>) &#123;</div><div class="line">        decodeImage = [decodeImage TransformtoSize:<span class="built_in">CGSizeMake</span>(<span class="number">640</span>, <span class="number">640</span>)];</div><div class="line">    &#125;</div><div class="line">    QRCodeZBarReaderController* read = [QRCodeZBarReaderController new];</div><div class="line">    <span class="built_in">CGImageRef</span> cgImageRef = decodeImage.CGImage;</div><div class="line">    QRCodeZBarSymbol *symbol = <span class="literal">nil</span>;</div><div class="line">    <span class="keyword">for</span>(symbol <span class="keyword">in</span> [read scanImage:cgImageRef]) <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">return</span> symbol.data;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p></blockquote><ul><li>方案A：先执行任务A，如果获取到的字符串为空，再执行任务B。</li></ul><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">+ (<span class="built_in">NSString</span> *)planOneDecodeWithImage:(<span class="built_in">UIImage</span> *)image index:(<span class="built_in">NSInteger</span>)index&#123;</div><div class="line"> </div><div class="line">    <span class="built_in">NSMutableString</span> *costTimeInfo = [<span class="built_in">NSMutableString</span> stringWithFormat:<span class="string">@"%ld\r\n"</span>,index];</div><div class="line">    <span class="built_in">CFAbsoluteTime</span> startTime = <span class="built_in">CFAbsoluteTimeGetCurrent</span>();</div><div class="line">    <span class="built_in">NSString</span> *detectorString = [MUIQRCodeDecoder useSystemMethodDecodeImage:image];</div><div class="line">    <span class="built_in">CFAbsoluteTime</span> detectorCostTime = (<span class="built_in">CFAbsoluteTimeGetCurrent</span>() - startTime);</div><div class="line">    </div><div class="line">    [costTimeInfo appendString:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"detector : %f ms\r\n"</span>,detectorCostTime *<span class="number">1000.0</span>]];</div><div class="line">    </div><div class="line">    <span class="built_in">NSAssert</span>(detectorString.length &gt; <span class="number">0</span>, <span class="string">@"detector fail!"</span>);</div><div class="line">    <span class="built_in">CFAbsoluteTime</span> zbarStartTime = <span class="built_in">CFAbsoluteTimeGetCurrent</span>();</div><div class="line">    <span class="built_in">NSString</span> *zbarSymbolString = [MUIQRCodeDecoder useZbarMethodDecodeImage:image];</div><div class="line">    <span class="built_in">NSAssert</span>(zbarSymbolString.length &gt; <span class="number">0</span>, <span class="string">@"zbar fail!"</span>);</div><div class="line">    <span class="built_in">CFAbsoluteTime</span> zbarCostTime = (<span class="built_in">CFAbsoluteTimeGetCurrent</span>() - zbarStartTime);</div><div class="line">    </div><div class="line">    [costTimeInfo appendString:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"zbar : %f ms\r\n"</span>,zbarCostTime *<span class="number">1000.0</span>]];</div><div class="line">    </div><div class="line">    <span class="built_in">CFAbsoluteTime</span> totalCostTime = (<span class="built_in">CFAbsoluteTimeGetCurrent</span>() - startTime);</div><div class="line">    </div><div class="line">    [costTimeInfo appendString:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"total cost : %f ms\r\n"</span>,totalCostTime *<span class="number">1000.0</span>]];</div><div class="line">    [costTimeInfo appendString:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"detectorString : %@ ms\r\n"</span>,detectorString]];</div><div class="line">    [costTimeInfo appendString:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"zbarSymbolString : %@ ms\r\n"</span>,zbarSymbolString]];</div><div class="line">    <span class="keyword">return</span> [costTimeInfo <span class="keyword">copy</span>];</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><p>方案B：同时执行任务A和任务B，两者均执行完后，返回识别的结果；</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">+ (<span class="built_in">NSString</span> *)planTwoDecodeWithImage:(<span class="built_in">UIImage</span> *)image index:(<span class="built_in">NSInteger</span>)index &#123; </div><div class="line">    __block <span class="built_in">NSMutableString</span> *costTimeInfo = [<span class="built_in">NSMutableString</span> stringWithFormat:<span class="string">@"%ld\r\n"</span>,index];</div><div class="line">    __block <span class="built_in">NSString</span> *detectorString = <span class="literal">nil</span>;</div><div class="line">    __block <span class="built_in">NSString</span> *zbarSymbolString = <span class="literal">nil</span>;</div><div class="line">    </div><div class="line">    <span class="built_in">CFAbsoluteTime</span> startTime = <span class="built_in">CFAbsoluteTimeGetCurrent</span>();</div><div class="line">    </div><div class="line">    dispatch_semaphore_t semaphore = dispatch_semaphore_create(<span class="number">0</span>);</div><div class="line">    dispatch_group_t group = dispatch_group_create();</div><div class="line">    </div><div class="line">    dispatch_group_async(group, dispatch_get_global_queue(<span class="number">0</span>,<span class="number">0</span>), ^&#123;</div><div class="line">        detectorString = [MUIQRCodeDecoder useSystemMethodDecodeImage:image];</div><div class="line">        <span class="built_in">NSAssert</span>(detectorString.length &gt; <span class="number">0</span>, <span class="string">@"detector fail!"</span>);</div><div class="line">        <span class="built_in">CFAbsoluteTime</span> costTime = (<span class="built_in">CFAbsoluteTimeGetCurrent</span>() - startTime);</div><div class="line">        [costTimeInfo appendString:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"detector : %f ms\r\n"</span>,costTime *<span class="number">1000.0</span>]];</div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    dispatch_group_async(group, dispatch_get_global_queue(<span class="number">0</span>,<span class="number">0</span>), ^&#123;</div><div class="line">        zbarSymbolString = [MUIQRCodeDecoder useZbarMethodDecodeImage:image];</div><div class="line">        <span class="built_in">NSAssert</span>(zbarSymbolString.length &gt; <span class="number">0</span>, <span class="string">@"zbar fail!"</span>);</div><div class="line">        <span class="built_in">CFAbsoluteTime</span> costTime = (<span class="built_in">CFAbsoluteTimeGetCurrent</span>() - startTime);</div><div class="line">        [costTimeInfo appendString:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"zbar : %f ms\r\n"</span>,costTime *<span class="number">1000.0</span>]];</div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    dispatch_group_notify(group, dispatch_get_global_queue(<span class="number">0</span>,<span class="number">0</span>), ^&#123;</div><div class="line">        dispatch_semaphore_signal(semaphore);</div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);</div><div class="line">    </div><div class="line">    <span class="built_in">CFAbsoluteTime</span> totalCostTime = (<span class="built_in">CFAbsoluteTimeGetCurrent</span>() - startTime);</div><div class="line">    [costTimeInfo appendString:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"total cost : %f ms\r\n"</span>,totalCostTime *<span class="number">1000.0</span>]];</div><div class="line">    [costTimeInfo appendString:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"detectorString : %@ ms\r\n"</span>,detectorString]];</div><div class="line">    [costTimeInfo appendString:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"zbarSymbolString : %@ ms\r\n"</span>,zbarSymbolString]];</div><div class="line">    <span class="keyword">return</span> [costTimeInfo <span class="keyword">copy</span>];</div><div class="line">&#125;</div></pre></td></tr></table></figure></li><li><p>方案C：同时执行任务A和任务B<br>1、任务A先执行完且识别成功，返回识别结果；<br>2、任务B先执行完且识别成功，返回识别结果；<br>3、任务A和任务B均识别失败，两者均执行完后，返回识别的结果。<br>```objc</p></li></ul><ul><li><p>(NSString <em>)planThreeDecodeWithImage:(UIImage </em>)image index:(NSInteger)index {<br><strong>block NSMutableString *costTimeInfo = [NSMutableString stringWithFormat:@”%ld\r\n”,index]; </strong>block NSString <em>detectorString = nil;<br>__block NSString </em>zbarSymbolString = nil;<br>__block BOOL isNeedSendSignal = YES;</p><p>CFAbsoluteTime startTime = CFAbsoluteTimeGetCurrent();</p><p>dispatch_semaphore_t semaphore = dispatch_semaphore_create(0);<br>dispatch_group_t group = dispatch_group_create();</p><p>dispatch_group_async(group, dispatch_get_global_queue(0,0), ^{</p><pre><code>detectorString = [MUIQRCodeDecoder useSystemMethodDecodeImage:image];//NSAssert(detectorString.length &gt; 0, @&quot;detector fail!&quot;);CFAbsoluteTime costTime = (CFAbsoluteTimeGetCurrent() - startTime);[costTimeInfo appendString:[NSString stringWithFormat:@&quot;detector : %f ms\r\n&quot;,costTime *1000.0]];if (detectorString.length &gt; 0 &amp;&amp; isNeedSendSignal) {    isNeedSendSignal = NO;    dispatch_semaphore_signal(semaphore);}</code></pre><p>});</p><p>dispatch_group_async(group, dispatch_get_global_queue(0,0), ^{</p><pre><code>zbarSymbolString = [MUIQRCodeDecoder useZbarMethodDecodeImage:image];//NSAssert(zbarSymbolString.length &gt; 0, @&quot;zbar fail!&quot;);CFAbsoluteTime costTime = (CFAbsoluteTimeGetCurrent() - startTime);[costTimeInfo appendString:[NSString stringWithFormat:@&quot;zbar : %f ms\r\n&quot;,costTime *1000.0]];if (zbarSymbolString.length &gt; 0 &amp;&amp; isNeedSendSignal) {    isNeedSendSignal = NO;    dispatch_semaphore_signal(semaphore);}</code></pre><p>});</p><p>dispatch_group_notify(group, dispatch_get_global_queue(0,0), ^{</p><pre><code>if (isNeedSendSignal) {    dispatch_semaphore_signal(semaphore);}</code></pre><p>});</p><p>dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);</p><p>CFAbsoluteTime totalCostTime = (CFAbsoluteTimeGetCurrent() - startTime);<br>[costTimeInfo appendString:[NSString stringWithFormat:@”total cost : %f ms\r\n”,totalCostTime *1000.0]];<br>[costTimeInfo appendString:[NSString stringWithFormat:@”detectorString : %@ ms\r\n”,detectorString]];<br>[costTimeInfo appendString:[NSString stringWithFormat:@”zbarSymbolString : %@ ms\r\n”,zbarSymbolString]];<br>return [costTimeInfo copy];<br>}<br>```<br>测试数据如下所示:(取了前10张图片）</p></li></ul><p><img src="https://upload-images.jianshu.io/upload_images/117999-04bca1bbc1f28805.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="识别二维码图片耗时.png"></p><p>分析测试数据发现：<br>1、在测试第一张二维码图片时，总耗时均较大，如果第一次识别使用的是系统方法，耗时超过500ms，这也是为什么会出现卡顿的原因；<br>2、使用系统方法去识别二维码图片时，如果不是第一次去识别，耗时较小，在65ms以内；<br>3、使用zbar的方法去识别二维码图片，耗时均值在200ms以内；<br>4、在方案C中，如果第一次使用系统方法，耗时为226ms。</p><p>总结得出，从优化卡顿问题的角度出发，使用方案C最优，同时发现，如果使用系统方法能识别出二维码图片，在初始化之后（也就是第二次使用），耗时最短。同时因为在实际的使用场景中，图片是一张一张识别的，识别过程有一个间隔时间，如果已经使用系统方法识别过二维码图片，那下次识别就能达到最优。所以使用方案C的话，最差情况均值在200ms左右，最好的情况和方案A中第二次使用系统方法耗时基本一致。综合考虑，使用方案C。</p><h4 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h4><p>在实际的项目开发过程中，设想的情况和实际情况会存在偏差，需要自己时刻使用性能调优工具，根据数据去进行优化，而不能想当然的认为某种方式是最优的。<br>源码和demo请点<a href="https://github.com/leverTsui/QRCodeDemo.git" target="_blank" rel="external">这里</a><br>参考的文章链接如下<br><a href="http://adad184.com/2015/09/30/goodbye-zxing/" target="_blank" rel="external">再见ZXing 使用系统原生代码处理QRCode</a><br><a href="http://blog.cnbluebox.com/blog/2014/08/26/ioser-wei-ma-sao-miao/" target="_blank" rel="external">IOS二维码扫描,你需要注意的两件事</a><br><a href="http://blog.csdn.net/u013738531/article/details/54574262" target="_blank" rel="external"><a href="http://blog.csdn.net/u013738531/article/details/54574262" target="_blank" rel="external">Zbar算法流程介绍</a></a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h4&gt;&lt;p&gt;之前做过一个关于二维码的组件，已发布，现总结下。&lt;br&gt;开发的&lt;code&gt;APP&lt;/code&gt;所需支持的最低版本为&lt;code&gt;8.0&lt;/co
      
    
    </summary>
    
      <category term="iOS 开发" scheme="http://leverTsui.github.io/categories/iOS-%E5%BC%80%E5%8F%91/"/>
    
    
      <category term="二维码 图片识别" scheme="http://leverTsui.github.io/tags/%E4%BA%8C%E7%BB%B4%E7%A0%81-%E5%9B%BE%E7%89%87%E8%AF%86%E5%88%AB/"/>
    
  </entry>
  
</feed>
